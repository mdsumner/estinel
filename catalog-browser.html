<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Satellite Image Browser with Ratings</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // UPDATE THIS URL to point to your JSON catalog on Pawsey
    const CATALOG_URL = 'https://projects.pawsey.org.au/estinel/catalog/image-catalog.json';

    // Sample data for testing (remove this when using real catalog)
    const SAMPLE_DATA = {
      locations: [
        {
          id: 'loc_001',
          name: 'Site A - Forest',
          images: Array.from({ length: 45 }, (_, i) => ({
            id: `loc_001_img_${String(i + 1).padStart(3, '0')}`,
            url: `https://picsum.photos/800/600?random=${i + 1}`,
            date: new Date(2024, 0, i * 8).toISOString().split('T')[0],
            thumbnail: `https://picsum.photos/200/150?random=${i + 1}`
          }))
        },
        {
          id: 'loc_002',
          name: 'Site B - Urban',
          images: Array.from({ length: 38 }, (_, i) => ({
            id: `loc_002_img_${String(i + 1).padStart(3, '0')}`,
            url: `https://picsum.photos/800/600?random=${i + 100}`,
            date: new Date(2024, 1, i * 7).toISOString().split('T')[0],
            thumbnail: `https://picsum.photos/200/150?random=${i + 100}`
          }))
        },
        {
          id: 'loc_003',
          name: 'Site C - Coastal',
          images: Array.from({ length: 52 }, (_, i) => ({
            id: `loc_003_img_${String(i + 1).padStart(3, '0')}`,
            url: `https://picsum.photos/800/600?random=${i + 200}`,
            date: new Date(2024, 2, i * 6).toISOString().split('T')[0],
            thumbnail: `https://picsum.photos/200/150?random=${i + 200}`
          }))
        }
      ]
    };

    // Lucide icons as inline SVG
    const ChevronLeft = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    );

    const ChevronRight = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    );

    const Grid3x3 = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="3" width="7" height="7"></rect>
        <rect x="14" y="3" width="7" height="7"></rect>
        <rect x="14" y="14" width="7" height="7"></rect>
        <rect x="3" y="14" width="7" height="7"></rect>
      </svg>
    );

    const Columns2 = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="3" width="7" height="18"></rect>
        <rect x="14" y="3" width="7" height="18"></rect>
      </svg>
    );

    const HelpCircle = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
    );

    const Crosshair = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="2" x2="12" y2="8"></line>
        <line x1="12" y1="16" x2="12" y2="22"></line>
        <line x1="2" y1="12" x2="8" y2="12"></line>
        <line x1="16" y1="12" x2="22" y2="12"></line>
      </svg>
    );

    const Star = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
      </svg>
    );

    const Download = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );

    const Upload = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
    );

    const Trash2 = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        <line x1="10" y1="11" x2="10" y2="17"></line>
        <line x1="14" y1="11" x2="14" y2="17"></line>
      </svg>
    );

    function SatImageBrowser() {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [selectedLocation, setSelectedLocation] = useState(null);
      const [currentIndex, setCurrentIndex] = useState(0);
      const [viewMode, setViewMode] = useState('slider');
      const [compareIndices, setCompareIndices] = useState([0, 1]);
      const [sliderPosition, setSliderPosition] = useState(50);
      const [showThumbnails, setShowThumbnails] = useState(true);
      const [showHelp, setShowHelp] = useState(false);
      const [showCrosshair, setShowCrosshair] = useState(false);
      const [viewType, setViewType] = useState(null);
      const thumbnailRefs = React.useRef({});
      const [initialLoad, setInitialLoad] = useState(true);

      // Rating system state
      const [ratings, setRatings] = useState({});
      const [showRatingPanel, setShowRatingPanel] = useState(false);
      const [ratingFilters, setRatingFilters] = useState(['good', 'ok', 'bad', 'unrated']); // Array of active filters
      const [showFilterDropdown, setShowFilterDropdown] = useState(false);
      const [rateAndNext, setRateAndNext] = useState(false);
      const [userId] = useState(() => {
        let id = localStorage.getItem('user_id');
        if (!id) {
          id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('user_id', id);
        }
        return id;
      });

      // Load ratings from localStorage
      useEffect(() => {
        const stored = localStorage.getItem('image_ratings');
        if (stored) {
          try {
            setRatings(JSON.parse(stored));
          } catch (e) {
            console.error('Failed to load ratings:', e);
          }
        }
      }, []);

      // Save ratings to localStorage
      useEffect(() => {
        localStorage.setItem('image_ratings', JSON.stringify(ratings));
      }, [ratings]);

      // Toggle a rating filter on/off
      const toggleRatingFilter = (filter) => {
        setRatingFilters(prev => {
          if (prev.includes(filter)) {
            // Remove filter if it exists
            return prev.filter(f => f !== filter);
          } else {
            // Add filter if it doesn't exist
            return [...prev, filter];
          }
        });
      };

      // Find next unrated image
      const findNextUnrated = () => {
        const currentIdx = currentImages.findIndex(img => img.id === currentImage.id);
        
        // Search forward from current position
        for (let i = currentIdx + 1; i < currentImages.length; i++) {
          if (!getRating(currentImages[i].id)) {
            return i;
          }
        }
        
        // Wrap around and search from beginning
        for (let i = 0; i < currentIdx; i++) {
          if (!getRating(currentImages[i].id)) {
            return i;
          }
        }
        
        // No unrated images found
        return null;
      };

      // Rate current image
      const rateImage = (imageId, rating) => {
        setRatings(prev => ({
          ...prev,
          [imageId]: {
            rating,
            timestamp: new Date().toISOString()
          }
        }));
        
        // If "Rate and Next" is enabled, jump to next unrated image
        if (rateAndNext && viewMode === 'single') {
          setTimeout(() => {
            const nextUnratedIdx = findNextUnrated();
            if (nextUnratedIdx !== null) {
              setCurrentIndex(nextUnratedIdx);
            }
          }, 100); // Small delay to ensure rating is saved first
        }
      };

      // Get rating for an image
      const getRating = (imageId) => {
        return ratings[imageId]?.rating || null;
      };

      // Calculate rating statistics
      const getRatingStats = () => {
        const stats = { good: 0, ok: 0, bad: 0, unrated: 0 };
        const allImages = data?.locations.flatMap(loc => loc.images) || [];
        
        allImages.forEach(img => {
          const rating = getRating(img.id);
          if (rating) {
            stats[rating]++;
          } else {
            stats.unrated++;
          }
        });
        
        return stats;
      };

      // Export ratings
      const exportRatings = () => {
        const exportData = {
          user_id: userId,
          timestamp: new Date().toISOString(),
          location: selectedLocation?.name || 'Unknown',
          ratings: Object.entries(ratings).map(([imageId, data]) => ({
            image_id: imageId,
            rating: data.rating,
            timestamp: data.timestamp
          }))
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `image-ratings-${userId}-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // Import ratings
      const importRatings = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const imported = JSON.parse(e.target.result);
            const newRatings = {};
            
            imported.ratings.forEach(item => {
              newRatings[item.image_id] = {
                rating: item.rating,
                timestamp: item.timestamp
              };
            });
            
            setRatings(prev => ({ ...prev, ...newRatings }));
            alert('Ratings imported successfully!');
          } catch (err) {
            alert('Failed to import ratings: ' + err.message);
          }
        };
        reader.readAsText(file);
      };

      // Clear all ratings
      const clearAllRatings = () => {
        if (confirm('Are you sure you want to clear all ratings? This cannot be undone.')) {
          setRatings({});
          localStorage.removeItem('image_ratings');
        }
      };

      // Filter images based on rating
      const getFilteredImages = (images) => {
        if (ratingFilters.length === 0) return []; // No filters selected = show nothing
        
        return images.filter(img => {
          const rating = getRating(img.id);
          
          // Check if image matches any of the active filters
          if (!rating && ratingFilters.includes('unrated')) return true;
          if (rating && ratingFilters.includes(rating)) return true;
          
          return false;
        });
      };

      // Get rating color
      const getRatingColor = (rating) => {
        switch (rating) {
          case 'good': return 'bg-green-500';
          case 'ok': return 'bg-yellow-500';
          case 'bad': return 'bg-red-500';
          default: return 'bg-gray-500';
        }
      };

      // Load catalog on mount
      useEffect(() => {
        fetch(CATALOG_URL)
          .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            return response.json();
          })
          .then(catalog => {
            setData(catalog);
            const firstLocation = catalog.locations[0];
            setSelectedLocation(firstLocation);
            setCurrentIndex(firstLocation.images.length - 1);
            setCompareIndices([firstLocation.images.length - 2, firstLocation.images.length - 1]);
            setLoading(false);
          })
          .catch(err => {
            console.warn('Could not load catalog, using sample data:', err.message);
            setData(SAMPLE_DATA);
            const firstLocation = SAMPLE_DATA.locations[0];
            setSelectedLocation(firstLocation);
            setCurrentIndex(firstLocation.images.length - 1);
            setCompareIndices([firstLocation.images.length - 2, firstLocation.images.length - 1]);
            setLoading(false);
          });
      }, []);

      const currentImages = selectedLocation?.images || [];
      const filteredImages = getFilteredImages(currentImages);
      
      // Reset currentIndex when filters change to stay within bounds
      useEffect(() => {
        if (viewMode === 'single' && filteredImages.length > 0) {
          if (currentIndex >= filteredImages.length) {
            setCurrentIndex(Math.max(0, filteredImages.length - 1));
          }
        }
      }, [ratingFilters, filteredImages.length, viewMode]);
      
      // Get current image - use filteredImages for single mode, currentImages for compare modes
      const currentImage = viewMode === 'single' 
        ? filteredImages[currentIndex] || filteredImages[0]
        : currentImages[compareIndices[0]];
      
      const availableViewTypes = currentImage && typeof currentImage.url === 'object' 
        ? Object.keys(currentImage.url)
        : ['view'];
      
      const activeViewType = viewType && availableViewTypes.includes(viewType) 
        ? viewType 
        : availableViewTypes[0];
      
      React.useEffect(() => {
        if (!viewType || !availableViewTypes.includes(viewType)) {
          setViewType(availableViewTypes[0]);
        }
      }, [availableViewTypes]);
      
      const getImageUrl = (img) => {
        if (typeof img.url === 'object') {
          return img.url[activeViewType] || img.url[availableViewTypes[0]];
        }
        return img.url;
      };
      
      const getThumbnailUrl = (img) => {
        if (typeof img.thumbnail === 'object') {
          return img.thumbnail[activeViewType] || img.thumbnail[availableViewTypes[0]];
        }
        return img.thumbnail;
      };

      useEffect(() => {
        if (viewMode === 'single' && currentImage) {
          // Find the index of current image in the full currentImages array
          const fullListIndex = currentImages.findIndex(img => img.id === currentImage.id);
          if (fullListIndex !== -1 && thumbnailRefs.current[fullListIndex]) {
            thumbnailRefs.current[fullListIndex]?.scrollIntoView({
              behavior: 'smooth',
              block: 'nearest'
            });
          }
        }
      }, [currentIndex, currentImage]);

      // Close filter dropdown when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (showFilterDropdown && !e.target.closest('.filter-dropdown-container')) {
            setShowFilterDropdown(false);
          }
        };
        
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, [showFilterDropdown]);

      useEffect(() => {
        if (selectedLocation && currentImages.length > 0 && initialLoad) {
          setTimeout(() => {
            const lastIndex = currentImages.length - 1;
            thumbnailRefs.current[lastIndex]?.scrollIntoView({
              behavior: 'auto',
              block: 'center'
            });
            setInitialLoad(false);
          }, 200);
        }
      }, [selectedLocation, initialLoad]);

      useEffect(() => {
        const handleKeyPress = (e) => {
          if (e.key === 'ArrowLeft') goToPrevious();
          if (e.key === 'ArrowRight') goToNext();
          if (e.key === 'g' || e.key === 'G') setShowThumbnails(prev => !prev);
          if (e.key === 'c' || e.key === 'C') setShowCrosshair(prev => !prev);
          if (e.key === '?') setShowHelp(prev => !prev);
          // Quick rating shortcuts
          if (e.key === '1') rateImage(currentImage.id, 'good');
          if (e.key === '2') rateImage(currentImage.id, 'ok');
          if (e.key === '3') rateImage(currentImage.id, 'bad');
        };
        window.addEventListener('keydown', handleKeyPress);
        return () => window.removeEventListener('keydown', handleKeyPress);
      }, [currentIndex, currentImages.length, currentImage]);

      const goToNext = () => {
        if (viewMode === 'single') {
          setCurrentIndex((prev) => (prev + 1) % filteredImages.length);
        } else {
          const isCtrl = window.event && window.event.ctrlKey;
          if (isCtrl) {
            setCompareIndices(prev => [Math.min(prev[0] + 1, prev[1] - 1), prev[1]]);
          } else {
            setCompareIndices(prev => [prev[0], Math.min(prev[1] + 1, currentImages.length - 1)]);
          }
        }
      };

      const goToPrevious = () => {
        if (viewMode === 'single') {
          setCurrentIndex((prev) => (prev - 1 + filteredImages.length) % filteredImages.length);
        } else {
          const isCtrl = window.event && window.event.ctrlKey;
          if (isCtrl) {
            setCompareIndices(prev => [prev[0], Math.max(prev[1] - 1, prev[0] + 1)]);
          } else {
            setCompareIndices(prev => [Math.max(prev[0] - 1, 0), prev[1]]);
          }
        }
      };

      const handleLocationChange = (location) => {
        setSelectedLocation(location);
        setCurrentIndex(location.images.length - 1);
        setCompareIndices([location.images.length - 2, location.images.length - 1]);
        setInitialLoad(true);
      };

      const handleThumbnailClick = (index) => {
        if (viewMode === 'single') {
          // In single mode, we need to find this image's index in the filtered array
          const clickedImage = currentImages[index];
          const filteredIndex = filteredImages.findIndex(img => img.id === clickedImage.id);
          if (filteredIndex !== -1) {
            setCurrentIndex(filteredIndex);
          }
        } else {
          if (window.event && window.event.ctrlKey) {
            setCompareIndices([compareIndices[0], index]);
          } else {
            setCompareIndices([index, compareIndices[1]]);
          }
        }
      };

      const toggleCompareMode = () => {
        if (viewMode === 'slider') {
          setViewMode('compare');
        } else if (viewMode === 'compare') {
          setCurrentIndex(compareIndices[0]);
          setViewMode('single');
        } else {
          let leftIdx, rightIdx;
          
          if (currentIndex === currentImages.length - 1) {
            leftIdx = Math.max(0, currentImages.length - 2);
            rightIdx = currentImages.length - 1;
          } else if (currentIndex <= 1) {
            leftIdx = 0;
            rightIdx = Math.min(1, currentImages.length - 1);
          } else {
            leftIdx = currentIndex;
            rightIdx = Math.min(currentIndex + 1, currentImages.length - 1);
          }
          
          setCompareIndices([leftIdx, rightIdx]);
          setSliderPosition(50);
          setViewMode('slider');
        }
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-screen bg-gray-900 text-gray-100">
            <div className="text-center">
              <div className="text-xl mb-2">Loading image catalog...</div>
              <div className="text-sm text-gray-400">Fetching from {CATALOG_URL}</div>
            </div>
          </div>
        );
      }

      if (!data || !selectedLocation) return null;

      const stats = getRatingStats();

      return (
        <div className="flex flex-col h-screen bg-gray-900 text-gray-100">
          {/* Header */}
          <div className="bg-gray-800 border-b border-gray-700 p-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <h1 className="text-xl font-bold">Satellite Image Browser</h1>
                <select
                  value={selectedLocation.id}
                  onChange={(e) => handleLocationChange(data.locations.find(l => l.id === e.target.value))}
                  className="bg-gray-700 text-gray-100 px-3 py-2 rounded border border-gray-600"
                >
                  {data.locations.map(loc => (
                    <option key={loc.id} value={loc.id}>
                      {loc.name} ({loc.images.length} images)
                    </option>
                  ))}
                </select>
                
                {availableViewTypes.length > 1 && (
                  <select
                    value={activeViewType}
                    onChange={(e) => setViewType(e.target.value)}
                    className="bg-gray-700 text-gray-100 px-3 py-2 rounded border border-gray-600"
                  >
                    {availableViewTypes.map(vt => (
                      <option key={vt} value={vt}>
                        {vt}
                      </option>
                    ))}
                  </select>
                )}

                <div className="relative filter-dropdown-container">
                  <button
                    onClick={() => setShowFilterDropdown(!showFilterDropdown)}
                    className="bg-gray-700 text-gray-100 px-3 py-2 rounded border border-gray-600 hover:bg-gray-600"
                  >
                    Filter Images ({ratingFilters.length}/4)
                  </button>
                  
                  {showFilterDropdown && (
                    <div className="absolute top-full mt-1 left-0 bg-gray-700 border border-gray-600 rounded shadow-lg z-50 min-w-[200px]">
                      <div className="p-2 space-y-2">
                        <label className="flex items-center gap-2 hover:bg-gray-600 p-2 rounded cursor-pointer">
                          <input
                            type="checkbox"
                            checked={ratingFilters.includes('good')}
                            onChange={() => toggleRatingFilter('good')}
                            className="w-4 h-4"
                          />
                          <span className="w-3 h-3 rounded-full bg-green-500"></span>
                          <span>Good ({stats.good})</span>
                        </label>
                        
                        <label className="flex items-center gap-2 hover:bg-gray-600 p-2 rounded cursor-pointer">
                          <input
                            type="checkbox"
                            checked={ratingFilters.includes('ok')}
                            onChange={() => toggleRatingFilter('ok')}
                            className="w-4 h-4"
                          />
                          <span className="w-3 h-3 rounded-full bg-yellow-500"></span>
                          <span>OK ({stats.ok})</span>
                        </label>
                        
                        <label className="flex items-center gap-2 hover:bg-gray-600 p-2 rounded cursor-pointer">
                          <input
                            type="checkbox"
                            checked={ratingFilters.includes('bad')}
                            onChange={() => toggleRatingFilter('bad')}
                            className="w-4 h-4"
                          />
                          <span className="w-3 h-3 rounded-full bg-red-500"></span>
                          <span>Bad ({stats.bad})</span>
                        </label>
                        
                        <label className="flex items-center gap-2 hover:bg-gray-600 p-2 rounded cursor-pointer">
                          <input
                            type="checkbox"
                            checked={ratingFilters.includes('unrated')}
                            onChange={() => toggleRatingFilter('unrated')}
                            className="w-4 h-4"
                          />
                          <span className="w-3 h-3 rounded-full bg-gray-500"></span>
                          <span>Unrated ({stats.unrated})</span>
                        </label>
                      </div>
                    </div>
                  )}
                </div>
              </div>
              
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setShowThumbnails(!showThumbnails)}
                  className={`p-2 rounded ${showThumbnails ? 'bg-blue-600' : 'bg-gray-700'} hover:bg-blue-700`}
                  title="Toggle thumbnails (G)"
                >
                  <Grid3x3 />
                </button>
                <button
                  onClick={toggleCompareMode}
                  className={`p-2 rounded ${viewMode !== 'single' ? 'bg-blue-600' : 'bg-gray-700'} hover:bg-blue-700`}
                  title="View mode (cycles: Slider → Side-by-side → Single)"
                >
                  <Columns2 />
                </button>
                <button
                  onClick={() => setShowCrosshair(!showCrosshair)}
                  className={`p-2 rounded ${showCrosshair ? 'bg-blue-600' : 'bg-gray-700'} hover:bg-blue-700`}
                  title="Toggle crosshair (C)"
                >
                  <Crosshair />
                </button>
                <button
                  onClick={() => setShowRatingPanel(!showRatingPanel)}
                  className={`p-2 rounded ${showRatingPanel ? 'bg-yellow-600' : 'bg-gray-700'} hover:bg-yellow-700`}
                  title="Toggle rating panel"
                >
                  <Star />
                </button>
                <button
                  onClick={() => setShowHelp(!showHelp)}
                  className={`p-2 rounded ${showHelp ? 'bg-blue-600' : 'bg-gray-700'} hover:bg-blue-700`}
                  title="Help"
                >
                  <HelpCircle />
                </button>
              </div>
            </div>
          </div>

          {/* Rating Panel */}
          {showRatingPanel && (
            <div className="bg-gray-800 border-b border-gray-700 p-4">
              <div className="max-w-6xl mx-auto">
                <div className="flex items-start justify-between gap-6">
                  {/* Quick Rate */}
                  <div className="flex-1">
                    <div className="flex items-center justify-between mb-2">
                      <h3 className="text-sm font-semibold text-gray-300">Quick Rate Current Image</h3>
                      <label className="flex items-center gap-2 text-xs text-gray-300 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={rateAndNext}
                          onChange={(e) => setRateAndNext(e.target.checked)}
                          className="w-4 h-4"
                        />
                        <span>Rate and Next</span>
                      </label>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => rateImage(currentImage.id, 'good')}
                        className={`flex-1 px-4 py-2 rounded font-semibold ${
                          getRating(currentImage.id) === 'good' 
                            ? 'bg-green-600 text-white' 
                            : 'bg-gray-700 text-gray-300 hover:bg-green-700'
                        }`}
                      >
                        Good
                      </button>
                      <button
                        onClick={() => rateImage(currentImage.id, 'ok')}
                        className={`flex-1 px-4 py-2 rounded font-semibold ${
                          getRating(currentImage.id) === 'ok' 
                            ? 'bg-yellow-600 text-white' 
                            : 'bg-gray-700 text-gray-300 hover:bg-yellow-700'
                        }`}
                      >
                        OK
                      </button>
                      <button
                        onClick={() => rateImage(currentImage.id, 'bad')}
                        className={`flex-1 px-4 py-2 rounded font-semibold ${
                          getRating(currentImage.id) === 'bad' 
                            ? 'bg-red-600 text-white' 
                            : 'bg-gray-700 text-gray-300 hover:bg-red-700'
                        }`}
                      >
                        Bad
                      </button>
                    </div>
                  </div>

                  {/* Statistics */}
                  <div className="flex-1">
                    <h3 className="text-sm font-semibold mb-2 text-gray-300">Rating Statistics</h3>
                    <div className="grid grid-cols-4 gap-2 text-xs">
                      <div className="bg-green-600 rounded p-2 text-center">
                        <div className="font-bold">{stats.good}</div>
                        <div>Good</div>
                      </div>
                      <div className="bg-yellow-600 rounded p-2 text-center">
                        <div className="font-bold">{stats.ok}</div>
                        <div>OK</div>
                      </div>
                      <div className="bg-red-600 rounded p-2 text-center">
                        <div className="font-bold">{stats.bad}</div>
                        <div>Bad</div>
                      </div>
                      <div className="bg-gray-600 rounded p-2 text-center">
                        <div className="font-bold">{stats.unrated}</div>
                        <div>Unrated</div>
                      </div>
                    </div>
                  </div>

                  {/* Actions */}
                  <div className="flex-1">
                    <h3 className="text-sm font-semibold mb-2 text-gray-300">Actions</h3>
                    <div className="flex flex-col gap-2">
                      <button
                        onClick={exportRatings}
                        className="flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm font-semibold"
                      >
                        <Download /> Export Ratings
                      </button>
                      <label className="flex items-center justify-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-sm font-semibold cursor-pointer">
                        <Upload /> Import Ratings
                        <input
                          type="file"
                          accept=".json"
                          onChange={importRatings}
                          className="hidden"
                        />
                      </label>
                      <button
                        onClick={clearAllRatings}
                        className="flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-sm font-semibold"
                      >
                        <Trash2 /> Clear All
                      </button>
                    </div>
                  </div>
                </div>
                <div className="mt-3 text-xs text-gray-400">
                  User ID: {userId} | Use keyboard shortcuts: 1=Good, 2=OK, 3=Bad
                </div>
              </div>
            </div>
          )}

          <div className="flex flex-1 overflow-hidden">
            {/* Main viewer */}
            <div className="flex-1 flex flex-col">
              {/* Image display */}
              <div className="flex-1 bg-black flex items-center justify-center p-4 overflow-auto">
                {viewMode === 'single' ? (
                  <div className="relative">
                    <img
                      src={getImageUrl(currentImage)}
                      alt={currentImage.id}
                      className="block"
                      style={{ imageRendering: 'pixelated' }}
                      loading="eager"
                    />
                    {showCrosshair && (
                      <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
                        <svg width="60" height="60" className="absolute">
                          <line x1="30" y1="0" x2="30" y2="20" stroke="red" strokeWidth="2" />
                          <line x1="30" y1="40" x2="30" y2="60" stroke="red" strokeWidth="2" />
                          <line x1="0" y1="30" x2="20" y2="30" stroke="red" strokeWidth="2" />
                          <line x1="40" y1="30" x2="60" y2="30" stroke="red" strokeWidth="2" />
                        </svg>
                      </div>
                    )}
                    <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 p-3 text-sm">
                      <div className="flex justify-between items-center">
                        <div>
                          <div className="font-mono">{currentImage.id}</div>
                          {getRating(currentImage.id) && (
                            <div className="mt-1">
                              <span className={`inline-block px-2 py-0.5 rounded text-xs font-semibold ${getRatingColor(getRating(currentImage.id))} text-white`}>
                                {getRating(currentImage.id).toUpperCase()}
                              </span>
                            </div>
                          )}
                        </div>
                        <div className="flex gap-2">
                          {currentImage.download && (
                            <a
                              href={currentImage.download}
                              download
                              className="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs font-semibold"
                            >
                              Download TIF
                            </a>
                          )}
                          {currentImage['stac-item'] && (
                            <a
                              href={currentImage['stac-item']}
                              download
                              className="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-xs font-semibold"
                            >
                              Download STAC
                            </a>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                ) : viewMode === 'compare' ? (
                  <div className="flex gap-4">
                    {compareIndices.map((idx, i) => {
                      const img = currentImages[idx];
                      return (
                        <div key={i} className="relative">
                          <img
                            src={getImageUrl(img)}
                            alt={img.id}
                            className="block"
                            style={{ imageRendering: 'pixelated' }}
                            loading="eager"
                          />
                          {showCrosshair && (
                            <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
                              <svg width="60" height="60" className="absolute">
                                <line x1="30" y1="0" x2="30" y2="20" stroke="red" strokeWidth="2" />
                                <line x1="30" y1="40" x2="30" y2="60" stroke="red" strokeWidth="2" />
                                <line x1="0" y1="30" x2="20" y2="30" stroke="red" strokeWidth="2" />
                                <line x1="40" y1="30" x2="60" y2="30" stroke="red" strokeWidth="2" />
                              </svg>
                            </div>
                          )}
                          <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 p-2 text-xs">
                            <div className="flex justify-between items-center">
                              <div>
                                <div className="font-mono">{img.id}</div>
                                {getRating(img.id) && (
                                  <span className={`inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold ${getRatingColor(getRating(img.id))} text-white mt-1`}>
                                    {getRating(img.id).toUpperCase()}
                                  </span>
                                )}
                              </div>
                              <div className="flex gap-1">
                                {img.download && (
                                  <a
                                    href={img.download}
                                    download
                                    className="px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-[10px] font-semibold"
                                  >
                                    TIF
                                  </a>
                                )}
                                {img['stac-item'] && (
                                  <a
                                    href={img['stac-item']}
                                    download
                                    className="px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-[10px] font-semibold"
                                  >
                                    STAC
                                  </a>
                                )}
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  <div className="relative inline-block">
                    <img
                      src={getImageUrl(currentImages[compareIndices[1]])}
                      alt={currentImages[compareIndices[1]].id}
                      className="block"
                      style={{ imageRendering: 'pixelated' }}
                      loading="eager"
                    />
                    
                    <img
                      src={getImageUrl(currentImages[compareIndices[0]])}
                      alt={currentImages[compareIndices[0]].id}
                      className="block absolute top-0 left-0 pointer-events-none"
                      style={{ 
                        imageRendering: 'pixelated',
                        clipPath: `inset(0 ${100 - sliderPosition}% 0 0)`
                      }}
                      loading="eager"
                    />
                    
                    <div 
                      className="absolute top-0 bottom-0 w-1 bg-white cursor-ew-resize"
                      style={{ left: `${sliderPosition}%`, transform: 'translateX(-50%)' }}
                      onMouseDown={(e) => {
                        const container = e.currentTarget.parentElement;
                        const handleDrag = (moveEvent) => {
                          const rect = container.getBoundingClientRect();
                          const x = moveEvent.clientX - rect.left;
                          const percent = Math.max(0, Math.min(100, (x / rect.width) * 100));
                          setSliderPosition(percent);
                        };
                        const handleRelease = () => {
                          document.removeEventListener('mousemove', handleDrag);
                          document.removeEventListener('mouseup', handleRelease);
                        };
                        document.addEventListener('mousemove', handleDrag);
                        document.addEventListener('mouseup', handleRelease);
                      }}
                    >
                      <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-white rounded-full shadow-lg flex items-center justify-center">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <polyline points="15 18 9 12 15 6"></polyline>
                          <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                      </div>
                    </div>
                    
                    {showCrosshair && (
                      <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
                        <svg width="60" height="60" className="absolute">
                          <line x1="30" y1="0" x2="30" y2="20" stroke="red" strokeWidth="2" />
                          <line x1="30" y1="40" x2="30" y2="60" stroke="red" strokeWidth="2" />
                          <line x1="0" y1="30" x2="20" y2="30" stroke="red" strokeWidth="2" />
                          <line x1="40" y1="30" x2="60" y2="30" stroke="red" strokeWidth="2" />
                        </svg>
                      </div>
                    )}
                    
                    <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 p-2 text-xs">
                      <div className="flex gap-4">
                        <div>
                          <span className="text-gray-400">Left: </span>
                          <span className="font-mono">{currentImages[compareIndices[0]].id}</span>
                          {getRating(currentImages[compareIndices[0]].id) && (
                            <span className={`ml-2 inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold ${getRatingColor(getRating(currentImages[compareIndices[0]].id))} text-white`}>
                              {getRating(currentImages[compareIndices[0]].id).toUpperCase()}
                            </span>
                          )}
                        </div>
                        <div>
                          <span className="text-gray-400">Right: </span>
                          <span className="font-mono">{currentImages[compareIndices[1]].id}</span>
                          {getRating(currentImages[compareIndices[1]].id) && (
                            <span className={`ml-2 inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold ${getRatingColor(getRating(currentImages[compareIndices[1]].id))} text-white`}>
                              {getRating(currentImages[compareIndices[1]].id).toUpperCase()}
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* Navigation controls */}
              <div className="bg-gray-800 border-t border-gray-700 p-4">
                <div className="flex items-center justify-between max-w-4xl mx-auto">
                  <button
                    onClick={goToPrevious}
                    className="flex items-center gap-2 px-4 py-2 bg-gray-700 rounded hover:bg-gray-600"
                  >
                    <ChevronLeft />
                    Previous
                  </button>
                  
                  <div className="text-center">
                    {viewMode === 'single' ? (
                      <div>
                        <div className="text-lg font-mono">
                          {currentIndex + 1} of {filteredImages.length} ({currentImage.date})
                        </div>
                        {ratingFilters.length < 4 && (
                          <div className="text-xs text-gray-400 mt-1">
                            Showing: {ratingFilters.map(f => f.charAt(0).toUpperCase() + f.slice(1)).join(', ')}
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="text-sm font-mono">
                        {viewMode === 'slider' ? 'Slider: ' : 'Comparing: '}
                        {compareIndices[0] + 1} & {compareIndices[1] + 1} ({currentImages[compareIndices[0]].date} / {currentImages[compareIndices[1]].date})
                      </div>
                    )}
                  </div>
                  
                  <button
                    onClick={goToNext}
                    className="flex items-center gap-2 px-4 py-2 bg-gray-700 rounded hover:bg-gray-600"
                  >
                    Next
                    <ChevronRight />
                  </button>
                </div>
              </div>
            </div>

            {/* Thumbnail panel */}
            {showThumbnails && (
              <div className="w-80 bg-gray-800 border-l border-gray-700 overflow-y-auto">
                <div className="p-4">
                  <h3 className="text-sm font-semibold mb-3 text-gray-400">
                    {selectedLocation.name} ({filteredImages.length} shown)
                  </h3>
                  <div className="grid grid-cols-2 gap-2">
                    {filteredImages.map((img, filteredIdx) => {
                      const rating = getRating(img.id);
                      const isCurrentInSingle = viewMode === 'single' && currentImage && img.id === currentImage.id;
                      // For compare mode, we need to check if this image is in the compareIndices
                      const fullIdx = currentImages.findIndex(ci => ci.id === img.id);
                      const isInCompare = (viewMode === 'compare' || viewMode === 'slider') && compareIndices.includes(fullIdx);
                      
                      return (
                        <div
                          key={img.id}
                          ref={el => thumbnailRefs.current[fullIdx] = el}
                          onClick={() => handleThumbnailClick(fullIdx)}
                          className={`cursor-pointer border-2 rounded overflow-hidden transition-all relative ${
                            isCurrentInSingle
                              ? 'border-blue-500'
                              : isInCompare
                              ? 'border-green-500'
                              : 'border-gray-700 hover:border-gray-500'
                          }`}
                        >
                          {rating && (
                            <div className={`absolute top-1 right-1 w-3 h-3 rounded-full ${getRatingColor(rating)} border-2 border-white`}></div>
                          )}
                          <img
                            src={getThumbnailUrl(img)}
                            alt={img.id}
                            className="w-full h-24 object-cover"
                          />
                          <div className="bg-gray-900 p-1 text-xs">
                            <div className="font-mono truncate">#{fullIdx + 1}</div>
                            <div className="text-gray-400 text-[10px] truncate">{img.date}</div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Help panel */}
          {showHelp && (
            <div className="bg-gray-800 border-t border-gray-700 p-4">
              <div className="max-w-4xl mx-auto">
                <h3 className="text-lg font-bold mb-3">How to Use</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                  <div>
                    <h4 className="font-semibold text-blue-400 mb-2">Navigation</h4>
                    <ul className="space-y-1 text-gray-300">
                      <li>• <strong>← →</strong> arrows: Navigate through images</li>
                      <li>• <strong>G</strong> key: Toggle thumbnail panel</li>
                      <li>• <strong>C</strong> key: Toggle center crosshair</li>
                      <li>• Click thumbnails to jump to specific images</li>
                      <li>• Use dropdown to switch between locations</li>
                    </ul>
                    <div className="mt-3 text-xs text-gray-400">
                      <p><strong>Tip:</strong> If an image appears too dark, try a different 'view_type' (colour balance option available via the dropdown selector to the right of the location selector)</p>
                    </div>
                  </div>
                  <div>
                    <h4 className="font-semibold text-blue-400 mb-2">View Modes</h4>
                    <ul className="space-y-1 text-gray-300">
                      <li>• Click <strong>columns icon</strong> to cycle modes</li>
                      <li>• Modes: Slider → Side-by-side → Single</li>
                      <li>• Default: Slider mode with last 2 images</li>
                      <li>• <strong>←</strong>: Move left image backward</li>
                      <li>• <strong>→</strong>: Move right image forward</li>
                      <li>• <strong>Ctrl+←</strong>: Move right image backward</li>
                      <li>• <strong>Ctrl+→</strong>: Move left image forward</li>
                      <li>• <strong>Click</strong> thumbnail: Set left image</li>
                      <li>• <strong>Ctrl+Click</strong> thumbnail: Set right image</li>
                      <li>• In slider mode: Drag to reveal images</li>
                    </ul>
                  </div>
                  <div>
                    <h4 className="font-semibold text-yellow-400 mb-2">Rating System</h4>
                    <ul className="space-y-1 text-gray-300">
                      <li>• <strong>1</strong>: Rate as Good</li>
                      <li>• <strong>2</strong>: Rate as OK</li>
                      <li>• <strong>3</strong>: Rate as Bad</li>
                      <li>• Click <strong>★</strong> to show rating panel</li>
                      <li>• Use filter to show rated images</li>
                      <li>• <strong>Rate and Next</strong>: Auto-jump to next unrated image</li>
                      <li>• Export ratings to JSON file</li>
                      <li>• Import ratings from others</li>
                      <li>• Colored dots on thumbnails show ratings</li>
                    </ul>
                    <div className="mt-3 text-xs text-gray-400">
                      <p><strong>Contribute:</strong> Share your ratings as issues at <a href="https://github.com/mdsumner/estinel" target="_blank" className="text-blue-400 hover:underline">github.com/mdsumner/estinel</a></p>
                    </div>
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mt-4 pt-4 border-t border-gray-700">
                  <div>
                    <h4 className="font-semibold text-blue-400 mb-2">Files Available</h4>
                    <div className="text-gray-300 text-xs space-y-1">
                      <p>From the Download TIF address, replace:</p>
                      <ul className="space-y-1 mt-1">
                        <li>• <code className="bg-gray-900 px-1">.tif</code> → <code className="bg-gray-900 px-1">[view_type].png</code> for viewable PNG</li>
                        <li>• <code className="bg-gray-900 px-1">.tif</code> → <code className="bg-gray-900 px-1">_scl.tif</code> for Sentinel categories</li>
                      </ul>
                      <p className="text-[10px] text-gray-400 mt-2">STAC item JSON will be added</p>
                    </div>
                  </div>
                  <div>
                    <h4 className="font-semibold text-blue-400 mb-2">Read TIF in R</h4>
                    <div className="text-gray-300 text-xs space-y-1">
                      <p>Right-click "Download TIF" → Copy link address, then:</p>
                      <code className="block bg-gray-900 p-2 rounded mt-1 font-mono">
                        r &lt;- terra::rast("/vsicurl/[copied-address]")<br/>
                        terra::plotRGB(r, stretch = TRUE)
                      </code>
                      <p className="text-[10px] text-gray-400 mt-1">Other stretch options will be added here</p>
                    </div>
                  </div>
                </div>
                <div className="mt-4 pt-4 border-t border-gray-700 text-xs text-gray-400 text-center">
                  <p>This tool was built with Claude AI and is part of the estinel project at <a href="https://github.com/mdsumner/estinel" target="_blank" className="text-blue-400 hover:underline">github.com/mdsumner/estinel</a></p>
                  <p className="mt-2">Sentinel-2 imagery is queried from element84.com, processed with GDAL and the R targets package, and hosted on the Pawsey Supercomputing Research Centre</p>
                </div>
              </div>
            </div>
          )}

          {/* Keyboard shortcuts hint */}
          <div className="bg-gray-800 border-t border-gray-700 px-4 py-2 text-xs text-gray-400">
            Shortcuts: ← → navigate | G thumbnails | C crosshair | ? help | 1-3 quick rate | ★ rating panel
          </div>
        </div>
      );
    }

    ReactDOM.render(<SatImageBrowser />, document.getElementById('root'));
  </script>
</body>
</html>