<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Satellite Image Browser with Ratings</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    // Register all UTM zone definitions for proj4js
    for (var zone = 1; zone <= 60; zone++) {
      var zoneStr = zone.toString().padStart(2, '0');
      proj4.defs('EPSG:326' + zoneStr, '+proj=utm +zone=' + zone + ' +datum=WGS84 +units=m +no_defs');
      proj4.defs('EPSG:327' + zoneStr, '+proj=utm +zone=' + zone + ' +south +datum=WGS84 +units=m +no_defs');
    }
  </script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // UPDATE THIS URL to point to your JSON catalog on Pawsey
    const CATALOG_URL = 'image-catalog.json';

    // Sample data for testing (remove this when using real catalog)
    const SAMPLE_DATA = {
      locations: [
        {
          id: 'loc_001',
          name: 'Site A - Forest',
          images: Array.from({ length: 45 }, (_, i) => ({
            id: `loc_001_img_${String(i + 1).padStart(3, '0')}`,
            url: `https://picsum.photos/800/600?random=${i + 1}`,
            date: new Date(2024, 0, i * 8).toISOString().split('T')[0],
            thumbnail: `https://picsum.photos/200/150?random=${i + 1}`
          }))
        },
        {
          id: 'loc_002',
          name: 'Site B - Urban',
          images: Array.from({ length: 38 }, (_, i) => ({
            id: `loc_002_img_${String(i + 1).padStart(3, '0')}`,
            url: `https://picsum.photos/800/600?random=${i + 100}`,
            date: new Date(2024, 1, i * 7).toISOString().split('T')[0],
            thumbnail: `https://picsum.photos/200/150?random=${i + 100}`
          }))
        },
        {
          id: 'loc_003',
          name: 'Site C - Coastal',
          images: Array.from({ length: 52 }, (_, i) => ({
            id: `loc_003_img_${String(i + 1).padStart(3, '0')}`,
            url: `https://picsum.photos/800/600?random=${i + 200}`,
            date: new Date(2024, 2, i * 6).toISOString().split('T')[0],
            thumbnail: `https://picsum.photos/200/150?random=${i + 200}`
          }))
        }
      ]
    };

    // Lucide icons as inline SVG
    const ChevronLeft = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    );

    const ChevronRight = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    );

    const Grid3x3 = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="3" width="7" height="7"></rect>
        <rect x="14" y="3" width="7" height="7"></rect>
        <rect x="14" y="14" width="7" height="7"></rect>
        <rect x="3" y="14" width="7" height="7"></rect>
      </svg>
    );

    const Columns2 = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="3" width="7" height="18"></rect>
        <rect x="14" y="3" width="7" height="18"></rect>
      </svg>
    );

    const HelpCircle = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
    );

    const Crosshair = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="2" x2="12" y2="8"></line>
        <line x1="12" y1="16" x2="12" y2="22"></line>
        <line x1="2" y1="12" x2="8" y2="12"></line>
        <line x1="16" y1="12" x2="22" y2="12"></line>
      </svg>
    );

    const Star = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
      </svg>
    );

    const Download = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );

    const Upload = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
    );

    const Trash2 = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        <line x1="10" y1="11" x2="10" y2="17"></line>
        <line x1="14" y1="11" x2="14" y2="17"></line>
      </svg>
    );

    const Play = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polygon points="5 3 19 12 5 21 5 3"></polygon>
      </svg>
    );

    const Pause = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="6" y="4" width="4" height="16"></rect>
        <rect x="14" y="4" width="4" height="16"></rect>
      </svg>
    );


    // ============================================================================
    // URL SHARING UTILITIES
    // ============================================================================

    const parseUrlParams = () => {
      const params = new URLSearchParams(window.location.search);
      const hash = window.location.hash.slice(1);
      
      if (hash && hash.length === 8) {
        const stored = localStorage.getItem('estinel_urlShortcodes');
        if (stored) {
          try {
            const shortcodes = JSON.parse(stored);
            if (shortcodes[hash]) {
              return shortcodes[hash];
            }
          } catch (e) {
            console.warn('Failed to parse short URL:', e);
          }
        }
      }
      
      return {
        location: params.get('location'),
        date: params.get('date'),
        date1: params.get('date1'),
        date2: params.get('date2'),
        index: params.get('index') ? parseInt(params.get('index')) : null,
        viewtype: params.get('viewtype'),
        mode: params.get('mode'),
        purpose: params.get('purpose')?.split(',').filter(Boolean) || null,
        rating: params.get('rating')?.split(',').filter(Boolean) || null,
        crosshair: params.get('crosshair') === 'true',
        thumbnails: params.get('thumbnails') !== 'false',
        sort: params.get('sort') || 'recent'
      };
    };

    const generateShareUrl = (state) => {
      const params = new URLSearchParams();
      
      if (state.location) params.set('location', state.location);
      if (state.date) params.set('date', state.date);
      if (state.date1) params.set('date1', state.date1);
      if (state.date2) params.set('date2', state.date2);
      if (state.index !== null && state.index !== undefined) params.set('index', state.index);
      if (state.viewtype) params.set('viewtype', state.viewtype);
      if (state.mode && state.mode !== 'single') params.set('mode', state.mode);
      if (state.purpose && state.purpose.length > 0) params.set('purpose', state.purpose.join(','));
      if (state.rating && state.rating.length > 0) params.set('rating', state.rating.join(','));
      if (state.crosshair) params.set('crosshair', 'true');
      if (!state.thumbnails) params.set('thumbnails', 'false');
      if (state.sort !== 'recent') params.set('sort', state.sort);
      
      const url = new URL(window.location.href);
      url.search = params.toString();
      url.hash = '';
      return url.toString();
    };

    const generateShortUrlFromState = (state) => {
      const fullUrl = generateShareUrl(state);
      const params = new URL(fullUrl).search;
      
      let hash = 0;
      for (let i = 0; i < params.length; i++) {
        const char = params.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      const shortCode = Math.abs(hash).toString(36).padStart(8, '0').slice(0, 8);
      
      const stored = localStorage.getItem('estinel_urlShortcodes') || '{}';
      const shortcodes = JSON.parse(stored);
      shortcodes[shortCode] = state;  // Store the state directly, not parseUrlParams()
      localStorage.setItem('estinel_urlShortcodes', JSON.stringify(shortcodes));
      
      const url = new URL(window.location.href);
      url.search = '';
      url.hash = shortCode;
      return url.toString();
    };

    const generateQRCode = (text) => {
      return new Promise((resolve, reject) => {
        const container = document.createElement('div');
        try {
          const qr = new QRCode(container, {
            text: text,
            width: 300,
            height: 300,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
          });
          
          setTimeout(() => {
            const canvas = container.querySelector('canvas');
            if (canvas) {
              resolve(canvas.toDataURL());
            } else {
              reject(new Error('QR code generation failed'));
            }
          }, 100);
        } catch (err) {
          reject(err);
        }
      });
    };

    function SatImageBrowser() {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [selectedLocation, setSelectedLocation] = useState(null);
      const [currentIndex, setCurrentIndex] = useState(0);
      const [viewMode, setViewMode] = useState('single');
      const [compareIndices, setCompareIndices] = useState([0, 1]);
      const [sliderPosition, setSliderPosition] = useState(50);
      const [showThumbnails, setShowThumbnails] = useState(true);
      const [showHelp, setShowHelp] = useState(false);
      const [showCrosshair, setShowCrosshair] = useState(false);
      const [viewType, setViewType] = useState(null);
      const thumbnailRefs = React.useRef({});
      const [initialLoad, setInitialLoad] = useState(true);

      // Rating system state
      const [ratings, setRatings] = useState({});
      const [showRatingPanel, setShowRatingPanel] = useState(false);
      const [ratingFilters, setRatingFilters] = useState(['good', 'ok', 'bad', 'unrated']); // Array of active filters
      const [showFilterDropdown, setShowFilterDropdown] = useState(false);
      const [rateAndNext, setRateAndNext] = useState(false);
      const [isPlaying, setIsPlaying] = useState(false);
      const [playSpeed, setPlaySpeed] = useState(1000); // milliseconds between images
      const [showUrlImport, setShowUrlImport] = useState(false);
      const [importUrl, setImportUrl] = useState('');
      const [externalLinks, setExternalLinks] = useState(null);
      const [imageCoords, setImageCoords] = useState(null);
      const [imageDimensions, setImageDimensions] = useState(null);
      const [showCoordPopup, setShowCoordPopup] = useState(false);
      const [copyFeedback, setCopyFeedback] = useState(null);
      const [locationSort, setLocationSort] = useState('recent'); // 'recent' or 'alphabetical'
      const [purposeFilters, setPurposeFilters] = useState([]); // Empty = show all
      const [showPurposeDropdown, setShowPurposeDropdown] = useState(false);
      const [userId] = useState(() => {
        let id = localStorage.getItem('user_id');
        if (!id) {
          id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('user_id', id);
        }
        return id;
      });
      
      // Share functionality state
      const [showShareMenu, setShowShareMenu] = useState(false);
      const [shareState, setShareState] = useState('idle');
      const [showQRModal, setShowQRModal] = useState(false);
      const [qrCodeData, setQrCodeData] = useState(null);
      const [shortUrl, setShortUrl] = useState(null);

      // Load ratings from localStorage
      useEffect(() => {
        const stored = localStorage.getItem('image_ratings');
        if (stored) {
          try {
            setRatings(JSON.parse(stored));
          } catch (e) {
            console.error('Failed to load ratings:', e);
          }
        }
      }, []);

      // Save ratings to localStorage
      useEffect(() => {
        localStorage.setItem('image_ratings', JSON.stringify(ratings));
      }, [ratings]);

      // Toggle a rating filter on/off
      const toggleRatingFilter = (filter) => {
        setRatingFilters(prev => {
          if (prev.includes(filter)) {
            // Remove filter if it exists
            return prev.filter(f => f !== filter);
          } else {
            // Add filter if it doesn't exist
            return [...prev, filter];
          }
        });
      };

      // Find next unrated image in the filtered list
      const findNextUnrated = () => {
        // Search forward from current position in filtered list
        for (let i = currentIndex + 1; i < filteredImages.length; i++) {
          if (!getRating(filteredImages[i].id)) {
            return i;
          }
        }
        
        // Wrap around and search from beginning of filtered list
        for (let i = 0; i < currentIndex; i++) {
          if (!getRating(filteredImages[i].id)) {
            return i;
          }
        }
        
        // No unrated images found in filtered list
        return null;
      };

      // Rate current image
      const rateImage = (imageId, rating) => {
        setRatings(prev => ({
          ...prev,
          [imageId]: {
            rating,
            timestamp: new Date().toISOString()
          }
        }));
        
        // If "Rate and Next" is enabled, jump to next unrated image
        if (rateAndNext && viewMode === 'single') {
          setTimeout(() => {
            const nextUnratedIdx = findNextUnrated();
            if (nextUnratedIdx !== null) {
              setCurrentIndex(nextUnratedIdx);
            }
          }, 100); // Small delay to ensure rating is saved first
        }
      };

      // Get rating for an image
      const getRating = (imageId) => {
        return ratings[imageId]?.rating || null;
      };

      // Calculate rating statistics
      const getRatingStats = () => {
        const stats = { good: 0, ok: 0, bad: 0, unrated: 0 };
        const allImages = data?.locations.flatMap(loc => loc.images) || [];
        
        allImages.forEach(img => {
          const rating = getRating(img.id);
          if (rating) {
            stats[rating]++;
          } else {
            stats.unrated++;
          }
        });
        
        return stats;
      };

      // Calculate rating statistics for current location only
      const getLocationRatingStats = () => {
        const stats = { good: 0, ok: 0, bad: 0, unrated: 0 };
        const locationImages = selectedLocation?.images || [];
        
        locationImages.forEach(img => {
          const rating = getRating(img.id);
          if (rating) {
            stats[rating]++;
          } else {
            stats.unrated++;
          }
        });
        
        return stats;
      };

      // Export ratings
      const exportRatings = () => {
        const exportData = {
          user_id: userId,
          timestamp: new Date().toISOString(),
          location: selectedLocation?.name || 'Unknown',
          ratings: Object.entries(ratings).map(([imageId, data]) => ({
            image_id: imageId,
            rating: data.rating,
            timestamp: data.timestamp
          }))
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `image-ratings-${userId}-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // Import ratings
      const importRatings = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const imported = JSON.parse(e.target.result);
            const newRatings = {};
            
            imported.ratings.forEach(item => {
              newRatings[item.image_id] = {
                rating: item.rating,
                timestamp: item.timestamp
              };
            });
            
            setRatings(prev => ({ ...prev, ...newRatings }));
            alert('Ratings imported successfully!');
          } catch (err) {
            alert('Failed to import ratings: ' + err.message);
          }
        };
        reader.readAsText(file);
      };

      // Import ratings from URL
      const importRatingsFromUrl = async (url) => {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          
          const imported = await response.json();
          const newRatings = {};
          
          imported.ratings.forEach(item => {
            newRatings[item.image_id] = {
              rating: item.rating,
              timestamp: item.timestamp
            };
          });
          
          setRatings(prev => ({ ...prev, ...newRatings }));
          setShowUrlImport(false);
          setImportUrl('');
          alert(`Ratings imported successfully from URL!\nImported ${imported.ratings.length} ratings from user ${imported.user_id}`);
        } catch (err) {
          alert('Failed to import ratings from URL: ' + err.message);
        }
      };

      // Clear all ratings
      const clearAllRatings = () => {
        if (confirm('Are you sure you want to clear all ratings? This cannot be undone.')) {
          setRatings({});
          localStorage.removeItem('image_ratings');
        }
      };

      // Filter images based on rating
      const getFilteredImages = (images) => {
        if (ratingFilters.length === 0) return []; // No filters selected = show nothing
        
        return images.filter(img => {
          const rating = getRating(img.id);
          
          // Check if image matches any of the active filters
          if (!rating && ratingFilters.includes('unrated')) return true;
          if (rating && ratingFilters.includes(rating)) return true;
          
          return false;
        });
      };

      // Get rating color
      const getRatingColor = (rating) => {
        switch (rating) {
          case 'good': return 'bg-green-500';
          case 'ok': return 'bg-yellow-500';
          case 'bad': return 'bg-red-500';
          default: return 'bg-gray-500';
        }
      };

      // Parse PAM .aux.xml metadata to get geotransform and EPSG code
      const parseAuxXml = async (imageUrl) => {
        try {
          const baseUrl = typeof imageUrl === 'string' ? imageUrl : Object.values(imageUrl)[0];
          const auxUrl = baseUrl + '.aux.xml';
          
          const response = await fetch(auxUrl);
          if (!response.ok) return null;
          
          const xmlText = await response.text();
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
          
          const geoTransformEl = xmlDoc.querySelector('GeoTransform');
          if (!geoTransformEl) return null;
          
          const gt = geoTransformEl.textContent.split(',').map(s => parseFloat(s.trim()));
          
          const srsEl = xmlDoc.querySelector('SRS');
          if (!srsEl) return null;
          
          const wkt = srsEl.textContent;
          const epsgMatches = wkt.match(/AUTHORITY\["EPSG","(\d+)"\]/g);
          if (!epsgMatches || epsgMatches.length === 0) return null;
          
          // Get the last EPSG code (the projection), not earlier ones (units, datum)
          const lastMatch = epsgMatches[epsgMatches.length - 1];
          const epsgNum = lastMatch.match(/(\d+)/);
          
          return { geoTransform: gt, epsg: parseInt(epsgNum[1]) };
        } catch (err) {
          console.warn('Could not fetch aux.xml:', err);
          return null;
        }
      };
      
      // Convert coordinates to lat/lon using proj4js
      const utmToLatLon = (x, y, epsg) => {
        const [lon, lat] = proj4(`EPSG:${epsg}`, 'EPSG:4326', [x, y]);
        return { lat, lon };
      };
      
      // Calculate image centre from geotransform
      const getImageCentre = (geoTransform, width = 1830, height = 1830) => {
        const [originX, pixelWidth, , originY, , pixelHeight] = geoTransform;
        return { 
          x: originX + (width / 2) * pixelWidth,
          y: originY + (height / 2) * pixelHeight 
        };
      };
      
      // Calculate bbox from geotransform
      const getBbox = (geoTransform, width = 1830, height = 1830) => {
        const [originX, pixelWidth, , originY, , pixelHeight] = geoTransform;
        const xmin = originX;
        const xmax = originX + width * pixelWidth;
        const ymax = originY;  // originY is top-left, pixelHeight is negative
        const ymin = originY + height * pixelHeight;
        return { xmin, ymin, xmax, ymax };
      };
      
      // Copy text to clipboard with feedback
      const copyToClipboard = async (text, label) => {
        try {
          await navigator.clipboard.writeText(text);
          setCopyFeedback(label);
          setTimeout(() => setCopyFeedback(null), 1500);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      };
      
      // Calculate appropriate zoom level from extent size in metres
      const calculateZoomFromExtent = (extentMetres) => {
        // Web Mercator: at zoom 0, world is ~40M metres wide
        // Each zoom level halves the extent shown
        // zoom = log2(40000000 / extent) - some adjustment for comfortable viewing
        // We want the image to fill roughly 50-70% of the viewport
        const worldSize = 40075016; // Earth circumference in metres
        const viewportFraction = 0.6; // Image should fill ~60% of view
        const zoom = Math.log2(worldSize / (extentMetres / viewportFraction));
        // Clamp to reasonable range and round
        return Math.min(18, Math.max(8, Math.round(zoom)));
      };
      
      // Convert zoom level to Google Maps altitude parameter
      const zoomToGoogleAltitude = (zoom, extentMetres) => {
        // Google Maps uses altitude in metres
        // Rough approximation: at zoom 12, altitude ~30000m for ~20km extent
        // altitude ‚âà extent * 1.5 works reasonably well
        return Math.round(extentMetres * 1.5);
      };
      
      // Generate external webmap links
      const generateExternalLinks = (lat, lon, date, extentMetres = 18300) => {
        const fromTime = `${date}T00:00:00.000Z`;
        const toTime = `${date}T23:59:59.999Z`;
        
        const zoom = calculateZoomFromExtent(extentMetres);
        const gmapAltitude = zoomToGoogleAltitude(zoom, extentMetres);
        
        return {
          esa: `https://browser.dataspace.copernicus.eu/?zoom=${zoom}&lat=${lat}&lng=${lon}&fromTime=${encodeURIComponent(fromTime)}&toTime=${encodeURIComponent(toTime)}&datasetId=S2_L2A_CDAS&cloudCoverage=30&dateMode=SINGLE&layerId=2_TONEMAPPED_NATURAL_COLOR`,
          maxar: `https://xpress.maxar.com/?lat=${lat}&lon=${lon}&zoom=${Math.max(8, zoom - 2)}`,
          gmap: `https://www.google.com/maps/@${lat},${lon},${gmapAltitude}m/data=!3m1!1e3`
        };
      };

      // Get all unique purposes from catalog
      const getAllPurposes = () => {
        if (!data) return [];
        const purposes = new Set();
        data.locations.forEach(loc => {
          if (loc.purpose) {
            // Purpose can be string or array
            const locPurposes = Array.isArray(loc.purpose) ? loc.purpose : [loc.purpose];
            locPurposes.forEach(p => purposes.add(p));
          } else {
            purposes.add('(undefined)');
          }
        });
        return Array.from(purposes).sort();
      };
      
      // Check if location matches purpose filters
      const locationMatchesPurpose = (location) => {
        if (purposeFilters.length === 0) return true; // No filter = show all
        
        const locPurposes = location.purpose 
          ? (Array.isArray(location.purpose) ? location.purpose : [location.purpose])
          : ['(undefined)'];
        
        // Location matches if any of its purposes are in the filter
        return locPurposes.some(p => purposeFilters.includes(p));
      };

      // Get sorted locations
      const getSortedLocations = () => {
        if (!data) return [];
        
        // First filter by purpose
        let locations = data.locations.filter(locationMatchesPurpose);
        
        if (locationSort === 'recent') {
          // Sort by most recent (maximum) date in each location
          locations.sort((a, b) => {
            const maxDateA = Math.max(...a.images.map(img => new Date(img.date).getTime()));
            const maxDateB = Math.max(...b.images.map(img => new Date(img.date).getTime()));
            return maxDateB - maxDateA; // Most recent first
          });
        } else {
          // Sort alphabetically
          locations.sort((a, b) => a.name.localeCompare(b.name));
        }
        
        return locations;
      };
      
      // Toggle a purpose filter
      const togglePurposeFilter = (purpose) => {
        setPurposeFilters(prev => {
          if (prev.includes(purpose)) {
            return prev.filter(p => p !== purpose);
          } else {
            return [...prev, purpose];
          }
        });
      };

      const copyShareUrl = async (useShortUrl = false) => {
        try {
          setShareState('copying');
          const state = {
            location: selectedLocation?.name,
            date: currentImage?.date,
            date1: viewMode !== 'single' ? currentImages[compareIndices[0]]?.date : null,
            date2: viewMode !== 'single' ? currentImages[compareIndices[1]]?.date : null,
            viewtype: activeViewType,
            mode: viewMode,
            purpose: purposeFilters.length > 0 ? purposeFilters : null,
            rating: ratingFilters.length < 4 ? ratingFilters : null,
            crosshair: showCrosshair,
            thumbnails: showThumbnails,
            sort: locationSort
          };
          
          const url = useShortUrl ? generateShortUrlFromState(state) : generateShareUrl(state);
          await navigator.clipboard.writeText(url);
          setShareState('success');
          setTimeout(() => {
            setShareState('idle');
            setShowShareMenu(false);
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
          setShareState('error');
          setTimeout(() => setShareState('idle'), 2000);
        }
      };

      const showQRCode = async (useShortUrl = false) => {
        try {
          const state = {
            location: selectedLocation?.name,
            date: currentImage?.date,
            date1: viewMode !== 'single' ? currentImages[compareIndices[0]]?.date : null,
            date2: viewMode !== 'single' ? currentImages[compareIndices[1]]?.date : null,
            viewtype: activeViewType,
            mode: viewMode,
            purpose: purposeFilters.length > 0 ? purposeFilters : null,
            rating: ratingFilters.length < 4 ? ratingFilters : null,
            crosshair: showCrosshair,
            thumbnails: showThumbnails,
            sort: locationSort
          };
          
          const url = useShortUrl ? generateShortUrlFromState(state) : generateShareUrl(state);
          setShortUrl(url);
          const qrData = await generateQRCode(url);
          setQrCodeData(qrData);
          setShowQRModal(true);
        } catch (err) {
          console.error('Failed to generate QR code:', err);
          alert('Failed to generate QR code');
        }
      };

      const shareViaEmail = () => {
        const state = {
          location: selectedLocation?.name,
          date: currentImage?.date,
          viewtype: activeViewType,
          mode: viewMode
        };
        const url = generateShareUrl(state);
        const subject = encodeURIComponent(`Estinel: ${selectedLocation?.name} - ${currentImage?.date}`);
        const body = encodeURIComponent(`Check out this satellite image:

${url}`);
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
      };

      const shareViaBluesky = () => {
        const state = {
          location: selectedLocation?.name,
          date: currentImage?.date,
          viewtype: activeViewType,
          mode: viewMode
        };
        const url = generateShareUrl(state);
        const text = encodeURIComponent(`Satellite imagery: ${selectedLocation?.name} (${currentImage?.date})

${url}`);
        window.open(`https://bsky.app/intent/compose?text=${text}`, '_blank');
      };


      // Load catalog on mount
      useEffect(() => {
        fetch(CATALOG_URL)
          .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            return response.json();
          })
          .then(catalog => {
            setData(catalog);
            setLoading(false);
          })
          .catch(err => {
            console.warn('Could not load catalog, using sample data:', err.message);
            setData(SAMPLE_DATA);

            setLoading(false);
          });
      }, []);

      const currentImages = selectedLocation?.images || [];
      const filteredImages = getFilteredImages(currentImages);
      
      // Reset currentIndex when filters change to stay within bounds
      useEffect(() => {
  
        if (viewMode === 'single' && filteredImages.length > 0 && selectedLocation) {
          if (currentIndex >= filteredImages.length) {
            console.log('BOUNDS CHECK: Resetting currentIndex from', currentIndex, 'to', filteredImages.length - 1); 
            setCurrentIndex(Math.max(0, filteredImages.length - 1));
          }
        }
      }, [ratingFilters, filteredImages.length, viewMode, selectedLocation]);

      // Set initial location when data loads
      useEffect(() => {
  
        if (data && data.locations.length > 0 && !selectedLocation) {
          const sorted = getSortedLocations();
          const firstLocation = sorted[0];
          setSelectedLocation(firstLocation);
          const lastImageIndex = firstLocation.images.length - 1;
          console.log('Setting currentIndex to:', lastImageIndex);  // ‚Üê ADD THIS LINE
          
          setCurrentIndex(lastImageIndex);
          setCompareIndices([
            Math.max(0, lastImageIndex - 1), 
            lastImageIndex
          ]);
        }
      }, [data]);  // Only depend on data, not locationSort
      
      // Get current image - use filteredImages for single mode, currentImages for compare modes
      const currentImage = viewMode === 'single' 
        ? filteredImages[currentIndex] || filteredImages[0]
        : currentImages[compareIndices[0]];
      
      const availableViewTypes = currentImage && typeof currentImage.url === 'object' 
        ? Object.keys(currentImage.url)
        : ['view'];
      
      const activeViewType = viewType && availableViewTypes.includes(viewType) 
        ? viewType 
        : availableViewTypes[0];
      
      React.useEffect(() => {
        if (!viewType || !availableViewTypes.includes(viewType)) {
          setViewType(availableViewTypes[0]);
        }
      }, [availableViewTypes]);
      
      const getImageUrl = (img) => {
        if (typeof img.url === 'object') {
          return img.url[activeViewType] || img.url[availableViewTypes[0]];
        }
        return img.url;
      };
      
      const getThumbnailUrl = (img) => {
        if (typeof img.thumbnail === 'object') {
          return img.thumbnail[activeViewType] || img.thumbnail[availableViewTypes[0]];
        }
        return img.thumbnail;
      };

      useEffect(() => {
        if (viewMode === 'single' && currentImage) {
          // Find the index of current image in the full currentImages array
          const fullListIndex = currentImages.findIndex(img => img.id === currentImage.id);
          if (fullListIndex !== -1 && thumbnailRefs.current[fullListIndex]) {
            thumbnailRefs.current[fullListIndex]?.scrollIntoView({
              behavior: 'smooth',
              block: 'nearest'
            });
          }
        }
      }, [currentIndex, currentImage]);

      // Store for current image metadata (geoTransform, epsg)
      const [currentMetadata, setCurrentMetadata] = useState(null);
      
      // Fetch image metadata when current image changes
      useEffect(() => {
        if (!currentImage) {
          setExternalLinks(null);
          setImageCoords(null);
          setCurrentMetadata(null);
          setImageDimensions(null);
          return;
        }
        
        const fetchMetadata = async () => {
          const imageUrl = typeof currentImage.url === 'object' 
            ? Object.values(currentImage.url)[0] 
            : currentImage.url;
          
          const metadata = await parseAuxXml(imageUrl);
          setCurrentMetadata(metadata);
        };
        
        fetchMetadata();
      }, [currentImage]);
      
      // Calculate coordinates when we have both metadata AND image dimensions
      useEffect(() => {
        if (!currentMetadata || !imageDimensions || !currentImage) {
          return;
        }
        
        const { width, height } = imageDimensions;
        const centre = getImageCentre(currentMetadata.geoTransform, width, height);
        const bbox = getBbox(currentMetadata.geoTransform, width, height);
        const latLon = utmToLatLon(centre.x, centre.y, currentMetadata.epsg);
        // Calculate extent size (use larger dimension)
        const extentX = Math.abs(bbox.xmax - bbox.xmin);
        const extentY = Math.abs(bbox.ymax - bbox.ymin);
        const extentMetres = Math.max(extentX, extentY);
        
        const links = generateExternalLinks(latLon.lat, latLon.lon, currentImage.date, extentMetres);
        
        setExternalLinks(links);
        setImageCoords({
          epsg: currentMetadata.epsg,
          centre: { x: centre.x, y: centre.y },
          centreLatLon: { lon: latLon.lon, lat: latLon.lat },
          bbox: bbox,
          dimensions: { width, height }
        });
      }, [currentMetadata, imageDimensions, currentImage]);

      // Close dropdowns when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (showFilterDropdown && !e.target.closest('.filter-dropdown-container')) {
            setShowFilterDropdown(false);
          }
          if (showPurposeDropdown && !e.target.closest('.purpose-dropdown-container')) {
            setShowPurposeDropdown(false);
          }
          if (showCoordPopup && !e.target.closest('.relative')) {
            setShowCoordPopup(false);
          }
        };
        
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, [showFilterDropdown, showPurposeDropdown, showCoordPopup]);

      // Close share menu when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (showShareMenu && !e.target.closest('.relative')) {
            setShowShareMenu(false);
          }
        };
        
        if (showShareMenu) {
          document.addEventListener('mousedown', handleClickOutside);
          return () => document.removeEventListener('mousedown', handleClickOutside);
        }
      }, [showShareMenu]);


      // Autoplay functionality
      useEffect(() => {
        if (!isPlaying || viewMode !== 'single') return;
        
        const interval = setInterval(() => {
          
          setCurrentIndex((prev) => (prev + 1) % filteredImages.length);
        }, playSpeed);
        
        return () => clearInterval(interval);
      }, [isPlaying, playSpeed, filteredImages.length, viewMode]);

      useEffect(() => {
        if (selectedLocation && currentImages.length > 0 && initialLoad) {
          setTimeout(() => {
            const lastIndex = currentImages.length - 1;
            thumbnailRefs.current[lastIndex]?.scrollIntoView({
              behavior: 'auto',
              block: 'center'
            });
            setInitialLoad(false);
          }, 200);
        }
      }, [selectedLocation, initialLoad]);

      useEffect(() => {
        const handleKeyPress = (e) => {
          if (e.key === 'ArrowLeft') goToPrevious();
          if (e.key === 'ArrowRight') goToNext();
          if (e.key === 'g' || e.key === 'G') setShowThumbnails(prev => !prev);
          if (e.key === 'c' || e.key === 'C') setShowCrosshair(prev => !prev);
          if (e.key === '?') setShowHelp(prev => !prev);
          if (e.key === ' ' && viewMode === 'single') {
            e.preventDefault(); // Prevent page scroll
            setIsPlaying(prev => !prev);
          }
          // Quick rating shortcuts
          if (e.key === '1') rateImage(currentImage.id, 'good');
          if (e.key === '2') rateImage(currentImage.id, 'ok');
          if (e.key === '3') rateImage(currentImage.id, 'bad');
        };
        window.addEventListener('keydown', handleKeyPress);
        return () => window.removeEventListener('keydown', handleKeyPress);
      }, [currentIndex, currentImages.length, currentImage, viewMode]);

      // Apply URL parameters on load
      useEffect(() => {
        if (!data || !selectedLocation) return;
        
        const urlParams = parseUrlParams();
        if (!urlParams.location && !urlParams.date && !urlParams.index) return;
        
        setTimeout(() => {
          if (urlParams.location) {
            const location = data.locations.find(l => l.name === urlParams.location);
            if (location && location.id !== selectedLocation.id) {
              setSelectedLocation(location);
            }
          }
          
          if (urlParams.viewtype && availableViewTypes.includes(urlParams.viewtype)) {
            setViewType(urlParams.viewtype);
          }
          
          if (urlParams.mode && ['single', 'compare', 'slider'].includes(urlParams.mode)) {
            setViewMode(urlParams.mode);
          }
          
          if (urlParams.purpose) {
            setPurposeFilters(urlParams.purpose);
          }
          if (urlParams.rating) {
            setRatingFilters(urlParams.rating);
          }
          
          if (typeof urlParams.crosshair === 'boolean') {
            setShowCrosshair(urlParams.crosshair);
          }
          if (typeof urlParams.thumbnails === 'boolean') {
            setShowThumbnails(urlParams.thumbnails);
          }
          if (urlParams.sort) {
            setLocationSort(urlParams.sort);
          }
          
          if (urlParams.mode === 'single') {
            if (urlParams.date) {
              // Find in FILTERED images, not currentImages
              const imgIndex = filteredImages.findIndex(img => img.date === urlParams.date);
              if (imgIndex !== -1) setCurrentIndex(imgIndex);
            }
          } else if (urlParams.date1 && urlParams.date2) {
            const idx1 = currentImages.findIndex(img => img.date === urlParams.date1);
            const idx2 = currentImages.findIndex(img => img.date === urlParams.date2);
            if (idx1 !== -1 && idx2 !== -1) {
              setCompareIndices([idx1, idx2]);
            }
          }
        }, 100);
      }, [data, selectedLocation?.id]);

      // Update selected location when purpose filters change
      useEffect(() => {
        if (!data || !selectedLocation) return;
        
        const sortedLocations = getSortedLocations();
        
        // If current location is not in filtered list, switch to first one
        const isCurrentLocationVisible = sortedLocations.some(loc => loc.id === selectedLocation.id);
        
        if (!isCurrentLocationVisible && sortedLocations.length > 0) {
          const newLocation = sortedLocations[0];
          setSelectedLocation(newLocation);
          const lastImageIndex = newLocation.images.length - 1;
          setCurrentIndex(lastImageIndex);
          setCompareIndices([
            Math.max(0, lastImageIndex - 1), 
            lastImageIndex
          ]);
        }
      }, [purposeFilters, data]);


      // Update selected location when purpose filters change
      useEffect(() => {
        if (!data || !selectedLocation) return;
        
        const sortedLocations = getSortedLocations();
        
        // If current location is not in filtered list, switch to first one
        const isCurrentLocationVisible = sortedLocations.some(loc => loc.id === selectedLocation.id);
        
        if (!isCurrentLocationVisible && sortedLocations.length > 0) {
          const newLocation = sortedLocations[0];
          setSelectedLocation(newLocation);
          const lastImageIndex = newLocation.images.length - 1;
          setCurrentIndex(lastImageIndex);
          setCompareIndices([
            Math.max(0, lastImageIndex - 1), 
            lastImageIndex
          ]);
        }
      }, [purposeFilters, data]);



      const goToNext = () => {
        if (viewMode === 'single') {
          setCurrentIndex((prev) => (prev + 1) % filteredImages.length);
        } else {
          const isCtrl = window.event && window.event.ctrlKey;
          if (isCtrl) {
            setCompareIndices(prev => [Math.min(prev[0] + 1, prev[1] - 1), prev[1]]);
          } else {
            setCompareIndices(prev => [prev[0], Math.min(prev[1] + 1, currentImages.length - 1)]);
          }
        }
      };

      const goToPrevious = () => {
        if (viewMode === 'single') {
          setCurrentIndex((prev) => (prev - 1 + filteredImages.length) % filteredImages.length);
        } else {
          const isCtrl = window.event && window.event.ctrlKey;
          if (isCtrl) {
            setCompareIndices(prev => [prev[0], Math.max(prev[1] - 1, prev[0] + 1)]);
          } else {
            setCompareIndices(prev => [Math.max(prev[0] - 1, 0), prev[1]]);
          }
        }
      };

      const handleLocationChange = (location) => {
        console.log('handleLocationChange called for:', location.name);  // ‚Üê ADD THIS
        
        setSelectedLocation(location);
        setCurrentIndex(location.images.length - 1);
        setCompareIndices([location.images.length - 2, location.images.length - 1]);
        setInitialLoad(true);
      };

      const handleThumbnailClick = (index) => {
        if (viewMode === 'single') {
          // In single mode, we need to find this image's index in the filtered array
          const clickedImage = currentImages[index];
          const filteredIndex = filteredImages.findIndex(img => img.id === clickedImage.id);
          if (filteredIndex !== -1) {
            setCurrentIndex(filteredIndex);
          }
        } else {
          if (window.event && window.event.ctrlKey) {
            setCompareIndices([compareIndices[0], index]);
          } else {
            setCompareIndices([index, compareIndices[1]]);
          }
        }
      };

      const toggleCompareMode = () => {
        if (viewMode === 'slider') {
          setViewMode('compare');
        } else if (viewMode === 'compare') {
          setCurrentIndex(compareIndices[0]);
          setViewMode('single');
        } else {
          let leftIdx, rightIdx;
          
          if (currentIndex === currentImages.length - 1) {
            leftIdx = Math.max(0, currentImages.length - 2);
            rightIdx = currentImages.length - 1;
          } else if (currentIndex <= 1) {
            leftIdx = 0;
            rightIdx = Math.min(1, currentImages.length - 1);
          } else {
            leftIdx = currentIndex;
            rightIdx = Math.min(currentIndex + 1, currentImages.length - 1);
          }
          
          setCompareIndices([leftIdx, rightIdx]);
          setSliderPosition(50);
          setViewMode('slider');
        }
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-screen bg-gray-900 text-gray-100">
            <div className="text-center">
              <div className="text-xl mb-2">Loading image catalog...</div>
              <div className="text-sm text-gray-400">Fetching from {CATALOG_URL}</div>
            </div>
          </div>
        );
      }

      if (!data || !selectedLocation) return null;
      console.log('Rendering with currentIndex:', currentIndex, 'filteredImages.length:', filteredImages.length);  // ‚Üê ADD THIS

      const stats = getRatingStats();

      return (
        <div className="flex flex-col h-screen bg-gray-900 text-gray-100">
          {/* Header */}
          <div className="bg-gray-800 border-b border-gray-700 p-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <h1 className="text-xl font-bold">Satellite Image Browser{(() => { const p = parseUrlParams(); return (p.location || p.date) ? <span className="ml-2 text-xs bg-blue-600 px-2 py-1 rounded">üìé Shared View</span> : null; })()}</h1>
                
                <button
                  onClick={() => setLocationSort(prev => prev === 'recent' ? 'alphabetical' : 'recent')}
                  className="bg-gray-700 text-gray-100 px-3 py-2 rounded border border-gray-600 hover:bg-gray-600 text-sm"
                  title={`Currently sorted by: ${locationSort === 'recent' ? 'Most Recent' : 'Alphabetical'}`}
                >
                  Sort: {locationSort === 'recent' ? 'üìÖ Recent' : 'üî§ A-Z'}
                </button>
                
                {getAllPurposes().length > 1 && (
                  <div className="relative purpose-dropdown-container">
                    <button
                      onClick={() => setShowPurposeDropdown(!showPurposeDropdown)}
                      className="bg-gray-700 text-gray-100 px-3 py-2 rounded border border-gray-600 hover:bg-gray-600 text-sm"
                      title="Filter locations by purpose"
                    >
                      Purpose {purposeFilters.length > 0 ? `(${purposeFilters.length})` : '(all)'}
                    </button>
                    
                    {showPurposeDropdown && (
                      <div className="absolute top-full mt-1 left-0 bg-gray-700 border border-gray-600 rounded shadow-lg z-50 min-w-[200px]">
                        <div className="p-2 space-y-1">
                          <div 
                            className="text-xs text-gray-400 px-2 py-1 cursor-pointer hover:text-gray-200"
                            onClick={() => setPurposeFilters([])}
                          >
                            Clear filters (show all)
                          </div>
                          
                              <div className="text-xs text-gray-400 px-2 py-1 border-t border-gray-600 pt-2 mt-1">
      <div>{data.locations.length} locations</div>
      <div>
        {(() => {
          if (purposeFilters.length === 0) {
            return `${data.locations.length} active`;
          }
          const activeCount = data.locations.filter(loc => {
            const locPurposes = loc.purpose 
              ? (Array.isArray(loc.purpose) ? loc.purpose : [loc.purpose])
              : ['(undefined)'];
            return locPurposes.some(p => purposeFilters.includes(p));
          }).length;
          return `${activeCount} active`;
        })()}
      </div>
    </div>
    
                          {getAllPurposes().map(purpose => (
                            <label key={purpose} className="flex items-center gap-2 hover:bg-gray-600 p-2 rounded cursor-pointer">
                              <input
                                type="checkbox"
                                checked={purposeFilters.includes(purpose)}
                                onChange={() => togglePurposeFilter(purpose)}
                                className="w-4 h-4"
                              />
                              <span className="text-sm">{purpose}</span>
                              <span className="text-xs text-gray-400 ml-auto">
                                ({data.locations.filter(loc => {
                                  const locPurposes = loc.purpose 
                                    ? (Array.isArray(loc.purpose) ? loc.purpose : [loc.purpose])
                                    : ['(undefined)'];
                                  return locPurposes.includes(purpose);
                                }).length})
                              </span>
                            </label>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}
                
                <select
                  value={selectedLocation?.id || ''}
                  onChange={(e) => handleLocationChange(getSortedLocations().find(l => l.id === e.target.value))}
                  className="bg-gray-700 text-gray-100 px-3 py-2 rounded border border-gray-600"
                >
                  {getSortedLocations().map(loc => {
                    const maxDate = loc.images.length > 0 
                      ? new Date(Math.max(...loc.images.map(img => new Date(img.date).getTime()))).toISOString().split('T')[0]
                      : 'N/A';
                    return (
                      <option key={loc.id} value={loc.id}>
                        {loc.name} ({loc.images.length} images{locationSort === 'recent' ? `, latest: ${maxDate}` : ''})
                      </option>
                    );
                  })}
                </select>
                
                {availableViewTypes.length > 1 && (
                  <select
                    value={activeViewType}
                    onChange={(e) => setViewType(e.target.value)}
                    className="bg-gray-700 text-gray-100 px-3 py-2 rounded border border-gray-600"
                  >
                    {availableViewTypes.map(vt => (
                      <option key={vt} value={vt}>
                        {vt}
                      </option>
                    ))}
                  </select>
                )}

                <div className="relative filter-dropdown-container">
                  <button
                    onClick={() => setShowFilterDropdown(!showFilterDropdown)}
                    className="bg-gray-700 text-gray-100 px-3 py-2 rounded border border-gray-600 hover:bg-gray-600"
                  >
                    Filter Images ({ratingFilters.length}/4)
                  </button>
                  
                  {showFilterDropdown && (
                    <div className="absolute top-full mt-1 left-0 bg-gray-700 border border-gray-600 rounded shadow-lg z-50 min-w-[200px]">
                      <div className="p-2 space-y-2">
                        <label className="flex items-center gap-2 hover:bg-gray-600 p-2 rounded cursor-pointer">
                          <input
                            type="checkbox"
                            checked={ratingFilters.includes('good')}
                            onChange={() => toggleRatingFilter('good')}
                            className="w-4 h-4"
                          />
                          <span className="w-3 h-3 rounded-full bg-green-500"></span>
                          <span>Good ({stats.good})</span>
                        </label>
                        
                        <label className="flex items-center gap-2 hover:bg-gray-600 p-2 rounded cursor-pointer">
                          <input
                            type="checkbox"
                            checked={ratingFilters.includes('ok')}
                            onChange={() => toggleRatingFilter('ok')}
                            className="w-4 h-4"
                          />
                          <span className="w-3 h-3 rounded-full bg-yellow-500"></span>
                          <span>OK ({stats.ok})</span>
                        </label>
                        
                        <label className="flex items-center gap-2 hover:bg-gray-600 p-2 rounded cursor-pointer">
                          <input
                            type="checkbox"
                            checked={ratingFilters.includes('bad')}
                            onChange={() => toggleRatingFilter('bad')}
                            className="w-4 h-4"
                          />
                          <span className="w-3 h-3 rounded-full bg-red-500"></span>
                          <span>Bad ({stats.bad})</span>
                        </label>
                        
                        <label className="flex items-center gap-2 hover:bg-gray-600 p-2 rounded cursor-pointer">
                          <input
                            type="checkbox"
                            checked={ratingFilters.includes('unrated')}
                            onChange={() => toggleRatingFilter('unrated')}
                            className="w-4 h-4"
                          />
                          <span className="w-3 h-3 rounded-full bg-gray-500"></span>
                          <span>Unrated ({stats.unrated})</span>
                        </label>
                      </div>
                    </div>
                  )}
                </div>
              </div>
              
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setIsPlaying(!isPlaying)}
                  className={`p-2 rounded ${isPlaying ? 'bg-green-600' : 'bg-gray-700'} hover:bg-green-700`}
                  title={isPlaying ? "Pause slideshow" : "Play slideshow"}
                  disabled={viewMode !== 'single'}
                >
                  {isPlaying ? <Pause /> : <Play />}
                </button>
                {viewMode === 'single' && (
                  <select
                    value={playSpeed}
                    onChange={(e) => setPlaySpeed(Number(e.target.value))}
                    className="bg-gray-700 text-gray-100 px-2 py-2 rounded border border-gray-600 text-sm"
                    title="Playback speed"
                  >
                    <option value={100}>Very Fast (0.1s)</option>
                    <option value={300}>Fast (0.3s)</option>
                    <option value={500}>Medium-Fast (0.5s)</option>
                    <option value={1000}>Medium (1s)</option>
                    <option value={2000}>Slow (2s)</option>
                    <option value={3000}>Very Slow (3s)</option>
                  </select>
                )}
                <button
                  onClick={() => setShowThumbnails(!showThumbnails)}
                  className={`p-2 rounded ${showThumbnails ? 'bg-blue-600' : 'bg-gray-700'} hover:bg-blue-700`}
                  title="Toggle thumbnails (G)"
                >
                  <Grid3x3 />
                </button>
                <button
                  onClick={toggleCompareMode}
                  className={`p-2 rounded ${viewMode !== 'single' ? 'bg-blue-600' : 'bg-gray-700'} hover:bg-blue-700`}
                  title="View mode (cycles: Slider ‚Üí Side-by-side ‚Üí Single)"
                >
                  <Columns2 />
                </button>
                <button
                  onClick={() => setShowCrosshair(!showCrosshair)}
                  className={`p-2 rounded ${showCrosshair ? 'bg-blue-600' : 'bg-gray-700'} hover:bg-blue-700`}
                  title="Toggle crosshair (C)"
                >
                  <Crosshair />
                </button>
                <button
                  onClick={() => setShowRatingPanel(!showRatingPanel)}
                  className={`p-2 rounded ${showRatingPanel ? 'bg-yellow-600' : 'bg-gray-700'} hover:bg-yellow-700`}
                  title="Toggle rating panel"
                >
                  <Star />
                </button>
                <div className="relative">
                  <button
                    onClick={() => setShowShareMenu(!showShareMenu)}
                    className={`p-2 rounded ${showShareMenu ? 'bg-blue-600' : 'bg-gray-700'} hover:bg-blue-700`}
                    title="Share this view"
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <circle cx="18" cy="5" r="3"></circle>
                      <circle cx="6" cy="12" r="3"></circle>
                      <circle cx="18" cy="19" r="3"></circle>
                      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                  </button>
                  
                  {showShareMenu && (
                    <div className="absolute top-full mt-2 right-0 bg-gray-700 border border-gray-600 rounded shadow-lg z-50 min-w-[220px]">
                      <div className="p-2 space-y-1">
                        <div className="text-xs text-gray-300 px-2 py-1 border-b border-gray-600">
                          <div className="font-semibold">Share Current View</div>
                          <div className="text-[10px] text-gray-400 mt-1">
                            {selectedLocation?.name} ‚Ä¢ {currentImage?.date}
                          </div>
                        </div>
                        
                        <button
                          onClick={() => copyShareUrl(false)}
                          disabled={shareState === 'copying'}
                          className="w-full text-left px-3 py-2 hover:bg-gray-600 rounded text-sm flex items-center gap-2"
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                          </svg>
                          {shareState === 'copying' ? 'Copying...' : shareState === 'success' ? '‚úì Copied!' : 'Copy Link'}
                        </button>
                        
                        <button
                          onClick={() => copyShareUrl(true)}
                          disabled={shareState === 'copying'}
                          className="w-full text-left px-3 py-2 hover:bg-gray-600 rounded text-sm flex items-center gap-2"
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                          </svg>
                          Copy Short Link
                        </button>
                        
                        <button
                          onClick={() => showQRCode(false)}
                          className="w-full text-left px-3 py-2 hover:bg-gray-600 rounded text-sm flex items-center gap-2"
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                          </svg>
                          Show QR Code
                        </button>
                        
                        <button
                          onClick={shareViaBluesky}
                          className="w-full text-left px-3 py-2 hover:bg-gray-600 rounded text-sm flex items-center gap-2"
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"></path>
                            <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                            <path d="M9 9h.01"></path>
                            <path d="M15 9h.01"></path>
                          </svg>
                          Share via Bluesky
                        </button>
                        
                        <button
                          onClick={shareViaEmail}
                          className="w-full text-left px-3 py-2 hover:bg-gray-600 rounded text-sm flex items-center gap-2"
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                          </svg>
                          Share via Email
                        </button>
                      </div>
                    </div>
                  )}
                </div>
                <button
                  onClick={() => setShowHelp(!showHelp)}
                  className={`p-2 rounded ${showHelp ? 'bg-blue-600' : 'bg-gray-700'} hover:bg-blue-700`}
                  title="Help"
                >
                  <HelpCircle />
                </button>
              </div>
            </div>
          </div>

          {/* Rating Panel */}
          {showRatingPanel && (
            <div className="bg-gray-800 border-b border-gray-700 p-4">
              <div className="max-w-6xl mx-auto">
                <div className="flex items-start justify-between gap-6">
                  {/* Quick Rate */}
                  <div className="flex-1">
                    <div className="flex items-center justify-between mb-2">
                      <h3 className="text-sm font-semibold text-gray-300">Quick Rate Current Image</h3>
                      <label className="flex items-center gap-2 text-xs text-gray-300 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={rateAndNext}
                          onChange={(e) => setRateAndNext(e.target.checked)}
                          className="w-4 h-4"
                        />
                        <span>Rate and Next</span>
                      </label>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => rateImage(currentImage.id, 'good')}
                        className={`flex-1 px-4 py-2 rounded font-semibold ${
                          getRating(currentImage.id) === 'good' 
                            ? 'bg-green-600 text-white' 
                            : 'bg-gray-700 text-gray-300 hover:bg-green-700'
                        }`}
                      >
                        Good
                      </button>
                      <button
                        onClick={() => rateImage(currentImage.id, 'ok')}
                        className={`flex-1 px-4 py-2 rounded font-semibold ${
                          getRating(currentImage.id) === 'ok' 
                            ? 'bg-yellow-600 text-white' 
                            : 'bg-gray-700 text-gray-300 hover:bg-yellow-700'
                        }`}
                      >
                        OK
                      </button>
                      <button
                        onClick={() => rateImage(currentImage.id, 'bad')}
                        className={`flex-1 px-4 py-2 rounded font-semibold ${
                          getRating(currentImage.id) === 'bad' 
                            ? 'bg-red-600 text-white' 
                            : 'bg-gray-700 text-gray-300 hover:bg-red-700'
                        }`}
                      >
                        Bad
                      </button>
                    </div>
                  </div>

                  {/* Statistics */}
                  <div className="flex-1">
                    <h3 className="text-sm font-semibold mb-2 text-gray-300">Rating Statistics</h3>
                    <div className="space-y-3">
                      <div>
                        <div className="text-xs text-gray-400 mb-1">Current Location: {selectedLocation?.name}</div>
                        <div className="grid grid-cols-4 gap-2 text-xs">
                          <div className="bg-green-600 rounded p-2 text-center">
                            <div className="font-bold">{getLocationRatingStats().good}</div>
                            <div>Good</div>
                          </div>
                          <div className="bg-yellow-600 rounded p-2 text-center">
                            <div className="font-bold">{getLocationRatingStats().ok}</div>
                            <div>OK</div>
                          </div>
                          <div className="bg-red-600 rounded p-2 text-center">
                            <div className="font-bold">{getLocationRatingStats().bad}</div>
                            <div>Bad</div>
                          </div>
                          <div className="bg-gray-600 rounded p-2 text-center">
                            <div className="font-bold">{getLocationRatingStats().unrated}</div>
                            <div>Unrated</div>
                          </div>
                        </div>
                      </div>
                      <div>
                        <div className="text-xs text-gray-400 mb-1">All Locations</div>
                        <div className="grid grid-cols-4 gap-2 text-xs">
                          <div className="bg-green-600 rounded p-2 text-center">
                            <div className="font-bold">{stats.good}</div>
                            <div>Good</div>
                          </div>
                          <div className="bg-yellow-600 rounded p-2 text-center">
                            <div className="font-bold">{stats.ok}</div>
                            <div>OK</div>
                          </div>
                          <div className="bg-red-600 rounded p-2 text-center">
                            <div className="font-bold">{stats.bad}</div>
                            <div>Bad</div>
                          </div>
                          <div className="bg-gray-600 rounded p-2 text-center">
                            <div className="font-bold">{stats.unrated}</div>
                            <div>Unrated</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Actions */}
                  <div className="flex-1">
                    <h3 className="text-sm font-semibold mb-2 text-gray-300">Actions</h3>
                    <div className="flex flex-col gap-2">
                      <button
                        onClick={exportRatings}
                        className="flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm font-semibold"
                      >
                        <Download /> Export Ratings
                      </button>
                      <label className="flex items-center justify-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-sm font-semibold cursor-pointer">
                        <Upload /> Import from File
                        <input
                          type="file"
                          accept=".json"
                          onChange={importRatings}
                          className="hidden"
                        />
                      </label>
                      <button
                        onClick={() => setShowUrlImport(!showUrlImport)}
                        className="flex items-center justify-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm font-semibold"
                      >
                        <Upload /> Import from URL
                      </button>
                      <button
                        onClick={clearAllRatings}
                        className="flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-sm font-semibold"
                      >
                        <Trash2 /> Clear All
                      </button>
                    </div>
                  </div>
                </div>
                <div className="mt-3 text-xs text-gray-400">
                  User ID: {userId} | Use keyboard shortcuts: 1=Good, 2=OK, 3=Bad
                </div>
              </div>
            </div>
          )}

          {/* URL Import Dialog */}
          {showUrlImport && (
            <div className="bg-gray-800 border-b border-gray-700 p-4">
              <div className="max-w-4xl mx-auto">
                <h3 className="text-sm font-semibold mb-2 text-gray-300">Import Ratings from URL</h3>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={importUrl}
                    onChange={(e) => setImportUrl(e.target.value)}
                    placeholder="https://example.com/ratings.json"
                    className="flex-1 bg-gray-700 text-gray-100 px-3 py-2 rounded border border-gray-600"
                  />
                  <button
                    onClick={() => importRatingsFromUrl(importUrl)}
                    disabled={!importUrl.trim()}
                    className="px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded text-sm font-semibold"
                  >
                    Import
                  </button>
                  <button
                    onClick={() => {
                      setShowUrlImport(false);
                      setImportUrl('');
                    }}
                    className="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-sm font-semibold"
                  >
                    Cancel
                  </button>
                </div>
                <div className="mt-2 text-xs text-gray-400">
                  Example: https://projects.pawsey.org.au/estinel/ratings/community-ratings.json
                </div>
              </div>
            </div>
          )}

          <div className="flex flex-1 overflow-hidden">
            {/* Main viewer */}
            <div className="flex-1 flex flex-col">
              {/* Image display */}
              <div className="flex-1 bg-black flex items-center justify-center p-4 overflow-auto">
                {viewMode === 'single' ? (
                  <div className="relative">
                    <img
                      src={getImageUrl(currentImage)}
                      alt={currentImage.id}
                      className="block"
                      style={{ imageRendering: 'pixelated' }}
                      loading="eager"
                      onLoad={(e) => {
                        const { naturalWidth, naturalHeight } = e.target;
                        setImageDimensions({ width: naturalWidth, height: naturalHeight });
                      }}
                    />
                    {showCrosshair && (
                      <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
                        <svg width="60" height="60" className="absolute">
                          <line x1="30" y1="0" x2="30" y2="20" stroke="red" strokeWidth="2" />
                          <line x1="30" y1="40" x2="30" y2="60" stroke="red" strokeWidth="2" />
                          <line x1="0" y1="30" x2="20" y2="30" stroke="red" strokeWidth="2" />
                          <line x1="40" y1="30" x2="60" y2="30" stroke="red" strokeWidth="2" />
                        </svg>
                      </div>
                    )}
                    <div className="bg-gray-900 p-3 text-sm">
                      <div className="flex justify-between items-center">
                        <div>
                          <div className="font-mono">{currentImage.id}</div>
                          {getRating(currentImage.id) && (
                            <div className="mt-1">
                              <span className={`inline-block px-2 py-0.5 rounded text-xs font-semibold ${getRatingColor(getRating(currentImage.id))} text-white`}>
                                {getRating(currentImage.id).toUpperCase()}
                              </span>
                            </div>
                          )}
                        </div>
                        <div className="flex gap-2">
                          {currentImage.download && (
                            <a
                              href={currentImage.download}
                              download
                              className="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs font-semibold"
                            >
                              Download TIF
                            </a>
                          )}
                          {currentImage['stac-item'] && (
                            <a
                              href={currentImage['stac-item']}
                              download
                              className="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-xs font-semibold"
                            >
                              Download STAC
                            </a>
                          )}
                          {externalLinks && (
                            <>
                              <a
                                href={externalLinks.esa}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs font-semibold"
                                title="Open in ESA Copernicus Browser"
                              >
                                ESA
                              </a>
                              <a
                                href={externalLinks.maxar}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="px-3 py-1 bg-orange-600 hover:bg-orange-700 rounded text-xs font-semibold"
                                title="Open in Maxar Xpress"
                              >
                                Maxar
                              </a>
                              <a
                                href={externalLinks.gmap}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-xs font-semibold"
                                title="Open in Google Maps"
                              >
                                GMap
                              </a>
                            </>
                          )}
                          {imageCoords && (
                            <div className="relative">
                              <button
                                onClick={() => setShowCoordPopup(!showCoordPopup)}
                                className="px-3 py-1 bg-cyan-600 hover:bg-cyan-700 rounded text-xs font-semibold"
                                title="View and copy coordinates"
                              >
                                üìç Coords
                              </button>
                              
                              {showCoordPopup && (
                                <div className="absolute bottom-full mb-2 right-0 bg-gray-800 border border-gray-600 rounded shadow-lg p-3 min-w-[320px] z-50">
                                  <div className="text-xs space-y-2">
                                    <div className="font-semibold text-gray-300 border-b border-gray-600 pb-1 mb-2">
                                      Image Coordinates
                                      {copyFeedback && <span className="ml-2 text-green-400">‚úì Copied {copyFeedback}</span>}
                                    </div>
                                    
                                    <div>
                                      <div className="text-gray-400 mb-1">DSN:</div>
                                      <div 
                                        className="font-mono text-[10px] cursor-pointer hover:text-cyan-400 bg-gray-900 px-1 rounded break-all"
                                        onClick={() => copyToClipboard('/vsicurl/' + getImageUrl(currentImage), 'DSN')}
                                        title="Click to copy GDAL vsicurl path"
                                      >
                                        /vsicurl/{getImageUrl(currentImage)}
                                      </div>
                                    </div>
                                    
                                    {imageCoords.dimensions && (
                                      <div className="border-t border-gray-700 pt-2">
                                        <div className="flex justify-between items-center">
                                          <span className="text-gray-400">Size (px):</span>
                                          <span 
                                            className="font-mono cursor-pointer hover:text-cyan-400"
                                            onClick={() => copyToClipboard(imageCoords.dimensions.width + ', ' + imageCoords.dimensions.height, 'Size px')}
                                            title="Click to copy width, height"
                                          >
                                            {imageCoords.dimensions.width} √ó {imageCoords.dimensions.height}
                                          </span>
                                        </div>
                                        <div className="flex justify-between items-center mt-1">
                                          <span className="text-gray-400">Resolution:</span>
                                          <span 
                                            className="font-mono cursor-pointer hover:text-cyan-400"
                                            onClick={() => {
                                              const res = Math.abs((imageCoords.bbox.xmax - imageCoords.bbox.xmin) / imageCoords.dimensions.width);
                                              copyToClipboard(res.toFixed(1), 'Resolution');
                                            }}
                                            title="Click to copy resolution in metres"
                                          >
                                            {Math.abs((imageCoords.bbox.xmax - imageCoords.bbox.xmin) / imageCoords.dimensions.width).toFixed(1)} m
                                          </span>
                                        </div>
                                        <div className="flex justify-between items-center mt-1">
                                          <span className="text-gray-400">Size (m):</span>
                                          <span 
                                            className="font-mono cursor-pointer hover:text-cyan-400"
                                            onClick={() => {
                                              const xSize = Math.abs(imageCoords.bbox.xmax - imageCoords.bbox.xmin);
                                              const ySize = Math.abs(imageCoords.bbox.ymax - imageCoords.bbox.ymin);
                                              copyToClipboard(xSize.toFixed(0) + ', ' + ySize.toFixed(0), 'Size m');
                                            }}
                                            title="Click to copy size in metres"
                                          >
                                            {Math.abs(imageCoords.bbox.xmax - imageCoords.bbox.xmin).toFixed(0)} √ó {Math.abs(imageCoords.bbox.ymax - imageCoords.bbox.ymin).toFixed(0)}
                                          </span>
                                        </div>
                                      </div>
                                    )}
                                    
                                    <div className="flex justify-between items-center">
                                      <span className="text-gray-400">CRS:</span>
                                      <span 
                                        className="font-mono cursor-pointer hover:text-cyan-400"
                                        onClick={() => copyToClipboard('EPSG:' + imageCoords.epsg, 'CRS')}
                                        title="Click to copy"
                                      >
                                        EPSG:{imageCoords.epsg}
                                      </span>
                                    </div>
                                    
                                    <div className="border-t border-gray-700 pt-2">
                                      <div className="text-gray-400 mb-1">Centre (projected x,y):</div>
                                      <div className="flex gap-2">
                                        <span 
                                          className="font-mono text-[11px] cursor-pointer hover:text-cyan-400 bg-gray-900 px-1 rounded"
                                          onClick={() => copyToClipboard(imageCoords.centre.x.toFixed(2) + ', ' + imageCoords.centre.y.toFixed(2), 'XY')}
                                          title="Click to copy X, Y"
                                        >
                                          {imageCoords.centre.x.toFixed(2)}, {imageCoords.centre.y.toFixed(2)}
                                        </span>
                                      </div>
                                    </div>
                                    
                                    <div className="border-t border-gray-700 pt-2">
                                      <div className="text-gray-400 mb-1">Centre (lon,lat):</div>
                                      <div className="flex gap-2">
                                        <span 
                                          className="font-mono text-[11px] cursor-pointer hover:text-cyan-400 bg-gray-900 px-1 rounded"
                                          onClick={() => copyToClipboard(imageCoords.centreLatLon.lon.toFixed(6) + ', ' + imageCoords.centreLatLon.lat.toFixed(6), 'Lon/Lat')}
                                          title="Click to copy Lon, Lat"
                                        >
                                          {imageCoords.centreLatLon.lon.toFixed(6)}, {imageCoords.centreLatLon.lat.toFixed(6)}
                                        </span>
                                      </div>
                                    </div>
                                    
                                    <div className="border-t border-gray-700 pt-2">
                                      <div className="text-gray-400 mb-1">Bbox (projected):</div>
                                      <div 
                                        className="font-mono text-[10px] cursor-pointer hover:text-cyan-400 bg-gray-900 px-1 rounded"
                                        onClick={() => copyToClipboard(
                                          imageCoords.bbox.xmin.toFixed(2) + ', ' + imageCoords.bbox.ymin.toFixed(2) + ', ' + imageCoords.bbox.xmax.toFixed(2) + ', ' + imageCoords.bbox.ymax.toFixed(2),
                                          'Bbox'
                                        )}
                                        title="Click to copy [xmin, ymin, xmax, ymax]"
                                      >
                                        {imageCoords.bbox.xmin.toFixed(2)}, {imageCoords.bbox.ymin.toFixed(2)}, {imageCoords.bbox.xmax.toFixed(2)}, {imageCoords.bbox.ymax.toFixed(2)}
                                      </div>
                                    </div>
                                    
                                    <div className="border-t border-gray-700 pt-2">
                                      <div className="text-gray-400 mb-1">Extent (xmin,xmax,ymin,ymax):</div>
                                      <div 
                                        className="font-mono text-[10px] cursor-pointer hover:text-cyan-400 bg-gray-900 px-1 rounded"
                                        onClick={() => copyToClipboard(
                                          imageCoords.bbox.xmin.toFixed(2) + ', ' + imageCoords.bbox.xmax.toFixed(2) + ', ' + imageCoords.bbox.ymin.toFixed(2) + ', ' + imageCoords.bbox.ymax.toFixed(2) ,
                                          'Extent'
                                        )}
                                        title="Click to copy [xmin, xmax, ymin, ymax]"
                                      >
                                        {imageCoords.bbox.xmin.toFixed(2)}, {imageCoords.bbox.xmax.toFixed(2)}, {imageCoords.bbox.ymin.toFixed(2)}, {imageCoords.bbox.ymax.toFixed(2)}
                                      </div>
                                    </div>
                                    
                                    <div className="border-t border-gray-700 pt-2">
                                      <button
                                        onClick={() => copyToClipboard(JSON.stringify({
                                          dsn: '/vsicurl/' + getImageUrl(currentImage),
                                          size_px: imageCoords.dimensions ? [imageCoords.dimensions.width, imageCoords.dimensions.height] : null,
                                          resolution_m: imageCoords.dimensions ? Math.abs((imageCoords.bbox.xmax - imageCoords.bbox.xmin) / imageCoords.dimensions.width) : null,
                                          size_m: imageCoords.dimensions ? [Math.abs(imageCoords.bbox.xmax - imageCoords.bbox.xmin), Math.abs(imageCoords.bbox.ymax - imageCoords.bbox.ymin)] : null,
                                          crs: 'EPSG:' + imageCoords.epsg,
                                          centre_xy: [imageCoords.centre.x, imageCoords.centre.y],
                                          centre_lonlat: [imageCoords.centreLatLon.lon, imageCoords.centreLatLon.lat],
                                          bbox_xy: [imageCoords.bbox.xmin, imageCoords.bbox.ymin, imageCoords.bbox.xmax, imageCoords.bbox.ymax],
                                          extent_xy: [imageCoords.bbox.xmin, imageCoords.bbox.xmax, imageCoords.bbox.ymin, imageCoords.bbox.ymax]
                                        }, null, 2), 'JSON')}
                                        className="w-full px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-[11px]"
                                      >
                                        Copy all as JSON
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                ) : viewMode === 'compare' ? (
                  <div className="flex gap-4">
                    {compareIndices.map((idx, i) => {
                      const img = currentImages[idx];
                      return (
                        <div key={i} className="relative">
                          <img
                            src={getImageUrl(img)}
                            alt={img.id}
                            className="block"
                            style={{ imageRendering: 'pixelated' }}
                            loading="eager"
                          />
                          {showCrosshair && (
                            <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
                              <svg width="60" height="60" className="absolute">
                                <line x1="30" y1="0" x2="30" y2="20" stroke="red" strokeWidth="2" />
                                <line x1="30" y1="40" x2="30" y2="60" stroke="red" strokeWidth="2" />
                                <line x1="0" y1="30" x2="20" y2="30" stroke="red" strokeWidth="2" />
                                <line x1="40" y1="30" x2="60" y2="30" stroke="red" strokeWidth="2" />
                              </svg>
                            </div>
                          )}
                          <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 p-2 text-xs">
                            <div className="flex justify-between items-center">
                              <div>
                                <div className="font-mono">{img.id}</div>
                                {getRating(img.id) && (
                                  <span className={`inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold ${getRatingColor(getRating(img.id))} text-white mt-1`}>
                                    {getRating(img.id).toUpperCase()}
                                  </span>
                                )}
                              </div>
                              <div className="flex gap-1">
                                {img.download && (
                                  <a
                                    href={img.download}
                                    download
                                    className="px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-[10px] font-semibold"
                                  >
                                    TIF
                                  </a>
                                )}
                                {img['stac-item'] && (
                                  <a
                                    href={img['stac-item']}
                                    download
                                    className="px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-[10px] font-semibold"
                                  >
                                    STAC
                                  </a>
                                )}
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  <div className="relative inline-block">
                    <img
                      src={getImageUrl(currentImages[compareIndices[1]])}
                      alt={currentImages[compareIndices[1]].id}
                      className="block"
                      style={{ imageRendering: 'pixelated' }}
                      loading="eager"
                    />
                    
                    <img
                      src={getImageUrl(currentImages[compareIndices[0]])}
                      alt={currentImages[compareIndices[0]].id}
                      className="block absolute top-0 left-0 pointer-events-none"
                      style={{ 
                        imageRendering: 'pixelated',
                        clipPath: `inset(0 ${100 - sliderPosition}% 0 0)`
                      }}
                      loading="eager"
                    />
                    
                    <div 
                      className="absolute top-0 bottom-0 w-1 bg-white cursor-ew-resize"
                      style={{ left: `${sliderPosition}%`, transform: 'translateX(-50%)' }}
                      onMouseDown={(e) => {
                        const container = e.currentTarget.parentElement;
                        const handleDrag = (moveEvent) => {
                          const rect = container.getBoundingClientRect();
                          const x = moveEvent.clientX - rect.left;
                          const percent = Math.max(0, Math.min(100, (x / rect.width) * 100));
                          setSliderPosition(percent);
                        };
                        const handleRelease = () => {
                          document.removeEventListener('mousemove', handleDrag);
                          document.removeEventListener('mouseup', handleRelease);
                        };
                        document.addEventListener('mousemove', handleDrag);
                        document.addEventListener('mouseup', handleRelease);
                      }}
                    >
                      <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-white rounded-full shadow-lg flex items-center justify-center">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <polyline points="15 18 9 12 15 6"></polyline>
                          <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                      </div>
                    </div>
                    
                    {showCrosshair && (
                      <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
                        <svg width="60" height="60" className="absolute">
                          <line x1="30" y1="0" x2="30" y2="20" stroke="red" strokeWidth="2" />
                          <line x1="30" y1="40" x2="30" y2="60" stroke="red" strokeWidth="2" />
                          <line x1="0" y1="30" x2="20" y2="30" stroke="red" strokeWidth="2" />
                          <line x1="40" y1="30" x2="60" y2="30" stroke="red" strokeWidth="2" />
                        </svg>
                      </div>
                    )}
                    
                    <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 p-2 text-xs">
                      <div className="flex gap-4">
                        <div>
                          <span className="text-gray-400">Left: </span>
                          <span className="font-mono">{currentImages[compareIndices[0]].id}</span>
                          {getRating(currentImages[compareIndices[0]].id) && (
                            <span className={`ml-2 inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold ${getRatingColor(getRating(currentImages[compareIndices[0]].id))} text-white`}>
                              {getRating(currentImages[compareIndices[0]].id).toUpperCase()}
                            </span>
                          )}
                        </div>
                        <div>
                          <span className="text-gray-400">Right: </span>
                          <span className="font-mono">{currentImages[compareIndices[1]].id}</span>
                          {getRating(currentImages[compareIndices[1]].id) && (
                            <span className={`ml-2 inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold ${getRatingColor(getRating(currentImages[compareIndices[1]].id))} text-white`}>
                              {getRating(currentImages[compareIndices[1]].id).toUpperCase()}
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* Navigation controls */}
              <div className="bg-gray-800 border-t border-gray-700 p-4">
                <div className="flex items-center justify-between max-w-4xl mx-auto">
                  <button
                    onClick={goToPrevious}
                    className="flex items-center gap-2 px-4 py-2 bg-gray-700 rounded hover:bg-gray-600"
                  >
                    <ChevronLeft />
                    Previous
                  </button>
                  
                  <div className="text-center">
                    {viewMode === 'single' ? (
                      <div>
                        <div className="text-lg font-mono">
                          {currentIndex + 1} of {filteredImages.length} ({currentImage.date})
                        </div>
                        {ratingFilters.length < 4 && (
                          <div className="text-xs text-gray-400 mt-1">
                            Showing: {ratingFilters.map(f => f.charAt(0).toUpperCase() + f.slice(1)).join(', ')}
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="text-sm font-mono">
                        {viewMode === 'slider' ? 'Slider: ' : 'Comparing: '}
                        {compareIndices[0] + 1} & {compareIndices[1] + 1} ({currentImages[compareIndices[0]].date} / {currentImages[compareIndices[1]].date})
                      </div>
                    )}
                  </div>
                  
                  <button
                    onClick={goToNext}
                    className="flex items-center gap-2 px-4 py-2 bg-gray-700 rounded hover:bg-gray-600"
                  >
                    Next
                    <ChevronRight />
                  </button>
                </div>
              </div>
            </div>

            {/* Thumbnail panel */}
            {showThumbnails && (
              <div className="w-80 bg-gray-800 border-l border-gray-700 overflow-y-auto">
                <div className="p-4">
                  <h3 className="text-sm font-semibold mb-3 text-gray-400">
                    {selectedLocation.name} ({filteredImages.length} shown)
                  </h3>
                  <div className="grid grid-cols-2 gap-2">
                    {filteredImages.map((img, filteredIdx) => {
                      const rating = getRating(img.id);
                      const isCurrentInSingle = viewMode === 'single' && currentImage && img.id === currentImage.id;
                      // For compare mode, we need to check if this image is in the compareIndices
                      const fullIdx = currentImages.findIndex(ci => ci.id === img.id);
                      const isInCompare = (viewMode === 'compare' || viewMode === 'slider') && compareIndices.includes(fullIdx);
                      
                      return (
                        <div
                          key={img.id}
                          ref={el => thumbnailRefs.current[fullIdx] = el}
                          onClick={() => handleThumbnailClick(fullIdx)}
                          className={`cursor-pointer border-2 rounded overflow-hidden transition-all relative ${
                            isCurrentInSingle
                              ? 'border-blue-500'
                              : isInCompare
                              ? 'border-green-500'
                              : 'border-gray-700 hover:border-gray-500'
                          }`}
                        >
                          {rating && (
                            <div className={`absolute top-1 right-1 w-3 h-3 rounded-full ${getRatingColor(rating)} border-2 border-white`}></div>
                          )}
                          <img
                            src={getThumbnailUrl(img)}
                            alt={img.id}
                            className="w-full h-24 object-cover"
                          />
                          <div className="bg-gray-900 p-1 text-xs">
                            <div className="font-mono truncate">#{fullIdx + 1}</div>
                            <div className="text-gray-400 text-[10px] truncate">{img.date}</div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}
          </div>

                    {/* Help panel */}
          {showHelp && (
            <div className="bg-gray-800 border-t border-gray-700 p-4">
              <div className="max-w-4xl mx-auto">
                <h3 className="text-lg font-bold mb-3">How to Use</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                  <div>
                    <h4 className="font-semibold text-blue-400 mb-2">üß≠ Navigation</h4>
                    <ul className="space-y-1 text-gray-300">
                      <li>‚Ä¢ <strong>‚Üê ‚Üí</strong> arrows: Navigate through images</li>
                      <li>‚Ä¢ <strong>Spacebar</strong>: Play/pause slideshow (single view)</li>
                      <li>‚Ä¢ <strong>G</strong> key: Toggle thumbnail panel</li>
                      <li>‚Ä¢ <strong>C</strong> key: Toggle centre crosshair</li>
                      <li>‚Ä¢ Click thumbnails to jump to specific images</li>
                      <li>‚Ä¢ Use dropdown to switch between locations</li>
                      <li>‚Ä¢ Adjust playback speed with dropdown</li>
                    </ul>
                    <div className="mt-3 pt-3 border-t border-gray-700 text-xs text-gray-400">
                      <p><strong>Tip:</strong> If an image appears too dark, try a different 'view_type' (colour balance option available via the dropdown selector to the right of the location selector)</p>
                    </div>
                  </div>
                  <div>
                    <h4 className="font-semibold text-blue-400 mb-2">üëÅÔ∏è View Modes</h4>
                    <ul className="space-y-1 text-gray-300">
                      <li>‚Ä¢ Click <strong>columns icon</strong> to cycle modes</li>
                      <li>‚Ä¢ Modes: Slider ‚Üí Side-by-side ‚Üí Single</li>
                      <li>‚Ä¢ Default: Single mode</li>
                      <li>‚Ä¢ <strong>‚Üê</strong>: Move left image backward</li>
                      <li>‚Ä¢ <strong>‚Üí</strong>: Move right image forward</li>
                      <li>‚Ä¢ <strong>Ctrl+‚Üê</strong>: Move right image backward</li>
                      <li>‚Ä¢ <strong>Ctrl+‚Üí</strong>: Move left image forward</li>
                      <li>‚Ä¢ <strong>Click</strong> thumbnail: Set left image</li>
                      <li>‚Ä¢ <strong>Ctrl+Click</strong> thumbnail: Set right image</li>
                      <li>‚Ä¢ In slider mode: Drag to reveal images</li>
                    </ul>
                  </div>
                  <div>
                    <h4 className="font-semibold text-yellow-400 mb-2">‚≠ê Rating System</h4>
                    <ul className="space-y-1 text-gray-300">
                      <li>‚Ä¢ <strong>1</strong>: Rate as Good</li>
                      <li>‚Ä¢ <strong>2</strong>: Rate as OK</li>
                      <li>‚Ä¢ <strong>3</strong>: Rate as Bad</li>
                      <li>‚Ä¢ Click <strong>‚òÖ</strong> to show rating panel</li>
                      <li>‚Ä¢ Use filter to show rated images</li>
                      <li>‚Ä¢ <strong>Rate and Next</strong>: Auto-jump to next unrated image</li>
                      <li>‚Ä¢ Export ratings to JSON file</li>
                      <li>‚Ä¢ Import ratings from file or URL</li>
                      <li>‚Ä¢ Coloured dots on thumbnails show ratings</li>
                    </ul>
                    <div className="mt-3 pt-3 border-t border-gray-700 text-xs text-gray-400">
                      <p><strong>Contribute:</strong> Share your ratings as issues at <a href="https://github.com/mdsumner/estinel" target="_blank" className="text-blue-400 hover:underline">github.com/mdsumner/estinel</a></p>
                      <p className="mt-1"><strong>Community ratings:</strong> Import shared ratings via URL to see others' classifications</p>
                    </div>
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mt-4 pt-4 border-t border-gray-700">
                  <div>
                    <h4 className="font-semibold text-blue-400 mb-2">üìÅ Files Available</h4>
                    <div className="text-gray-300 text-xs space-y-1">
                      <p>From the Download TIF address, replace:</p>
                      <ul className="space-y-1 mt-1">
                        <li>‚Ä¢ <code className="bg-gray-900 px-1">.tif</code> ‚Üí <code className="bg-gray-900 px-1">[view_type].png</code> for viewable PNG</li>
                        <li>‚Ä¢ <code className="bg-gray-900 px-1">.tif</code> ‚Üí <code className="bg-gray-900 px-1">_scl.tif</code> for Sentinel categories</li>
                      </ul>
                      <p className="text-[10px] text-gray-400 mt-2">STAC item JSON will be added</p>
                      <p className="text-[10px] text-gray-400 mt-1"><strong>External links:</strong> ESA (Copernicus Browser with date), Maxar, Google Maps</p>
                    </div>
                  </div>
                  <div>
                    <h4 className="font-semibold text-blue-400 mb-2">üìä Read TIF in R</h4>
                    <div className="text-gray-300 text-sm space-y-2">
                      <p className="text-xs">Right-click "Download TIF" ‚Üí Copy link address, then:</p>
                      <code className="block bg-gray-900 p-2 rounded mt-1 font-mono text-xs">
                        r &lt;- terra::rast("/vsicurl/[copied-address]")<br/>
                        terra::plotRGB(r, stretch = TRUE)
                      </code>
                      <details className="mt-2">
                        <summary className="text-xs text-gray-400 cursor-pointer hover:text-gray-300">
                          <strong>Advanced:</strong> Colour stretch methods ‚ñº
                        </summary>
                        <p className="text-xs text-gray-400 mt-2 pl-4">
                          Colour stretch options: 1) 'view_stretch' corresponds to "terra::stretch()" or "plotRGB(, stretch=TRUE)" 2) 'view_histeq' corresponds to 'terra::stretch(, histeq = TRUE, scale = 255)' 3) 'view_q128' uses a method defined in estinel function 'stretch_q128()'
                        </p>
                      </details>
                    </div>
                  </div>
                </div>
                <div className="mt-4 pt-4 border-t border-gray-700 text-xs text-gray-400 text-center">
                  <p>This tool was built with Claude AI and is part of the estinel project at <a href="https://github.com/mdsumner/estinel" target="_blank" className="text-blue-400 hover:underline">github.com/mdsumner/estinel</a></p>
                  <p className="mt-2">Sentinel-2 imagery is queried from element84.com, processed with GDAL and the R targets package, and hosted on the Pawsey Supercomputing Research Centre</p>
                </div>
              </div>
            </div>
          )}
          {/* QR Code Modal */}
          {showQRModal && (
            <div 
              className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
              onClick={() => setShowQRModal(false)}
            >
              <div 
                className="bg-gray-800 border border-gray-600 rounded-lg p-6 max-w-md"
                onClick={(e) => e.stopPropagation()}
              >
                <div className="flex justify-between items-start mb-4">
                  <h3 className="text-lg font-bold">Share via QR Code</h3>
                  <button
                    onClick={() => setShowQRModal(false)}
                    className="text-gray-400 hover:text-gray-200"
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
                
                {qrCodeData && (
                  <div className="flex flex-col items-center gap-4">
                    <img src={qrCodeData} alt="QR Code" className="border-4 border-white" />
                    
                    <div className="w-full">
                      <div className="text-xs text-gray-400 mb-1">Link:</div>
                      <div className="bg-gray-900 p-2 rounded text-xs font-mono break-all">
                        {shortUrl}
                      </div>
                    </div>
                    
                    <button
                      onClick={() => navigator.clipboard.writeText(shortUrl)}
                      className="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold"
                    >
                      Copy Link
                    </button>
                  </div>
                )}
              </div>
            </div>
          )}


          {/* Keyboard shortcuts hint */}
          <div className="bg-gray-800 border-t border-gray-700 px-4 py-2 text-xs text-gray-400">
            Shortcuts: ‚Üê ‚Üí navigate | Spacebar play/pause | G thumbnails | C crosshair | ? help | 1-3 quick rate | ‚òÖ rating panel
          </div>
        </div>
      );
    }

    ReactDOM.render(<SatImageBrowser />, document.getElementById('root'));
  </script>
</body>
</html>
